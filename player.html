<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduciendo...</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        video { width: 100vw; height: 100vh; object-fit: contain; background: #000; }
        .back-btn {
            position: absolute;
            top: 18px; left: 18px;
            z-index: 10;
            background: rgba(20,20,20,0.85);
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .back-btn:hover, .back-btn:focus { background: #E50914; color: #fff; }
        .error-msg {
            color: #fff;
            text-align: center;
            padding-top: 40vh;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn" id="backBtn">← Volver</a>
    <video id="videoPlayer" controls autoplay playsinline webkit-playsinline></video>
    <script>
        const video = document.getElementById('videoPlayer');
        const backBtn = document.getElementById('backBtn');
        const params = new URLSearchParams(window.location.search);
        const streamUrl = params.get('stream');
        const Storage = {
            get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
            set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {} }
        };

        function saveProgress() {
            if (!streamUrl || !video.duration || video.duration < 10) return;
            const progress = Storage.get("tv_progress_v11") || {};
            progress[streamUrl] = {
                currentTime: video.currentTime,
                duration: video.duration,
                progress: (video.currentTime / video.duration) * 100
            };
            Storage.set("tv_progress_v11", progress);
        }

        function goBack() {
            window.location.href = "index.html";
        }

        if (streamUrl) {
            const progress = Storage.get("tv_progress_v11")?.[streamUrl];
            if(progress?.currentTime) video.currentTime = progress.currentTime;
            if (/\.m3u8($|\?)/i.test(streamUrl) && Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
            } else {
                video.src = streamUrl;
            }
            video.play().catch(e => console.error("Autoplay bloqueado:", e));
            setInterval(saveProgress, 5000);
            window.addEventListener('beforeunload', saveProgress);

            // Teclas para volver
            document.addEventListener('keydown', e => {
                if (e.key === 'Backspace' || e.key === 'Escape') {
                    e.preventDefault();
                    goBack();
                }
            });
            // Botón volver
            backBtn.addEventListener('click', function(e) {
                e.preventDefault();
                goBack();
            });
        } else {
            document.body.innerHTML = `
                <div class="error-msg">
                    Error: URL no encontrada.<br>
                    <a href="index.html" class="back-btn" style="position:static;display:inline-block;margin-top:24px;">← Volver al menú</a>
                </div>
            `;
        }
    </script>
</body>
</html>
