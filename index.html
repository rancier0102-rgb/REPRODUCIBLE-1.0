<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Series+</title>
<style>
:root {
    --primary: #e50914;
    --primary-dark: #b2070f;
    --bg-dark: #0a0a0a;
    --bg-card: #141414;
    --bg-surface: #1a1a1a;
    --bg-elevated: #252525;
    --text-primary: #ffffff;
    --text-secondary: #a0a0a0;
    --text-muted: #5a5a5a;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --shadow: 0 4px 20px rgba(0,0,0,0.5);
    --transition: 0.25s ease;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
    --header-height: 56px;
    --nav-height: 56px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    line-height: 1.4;
}

.loader {
    position: fixed;
    inset: 0;
    background: var(--bg-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.4s ease;
}

.loader.hidden {
    opacity: 0;
    pointer-events: none;
}

.loader-logo {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 24px;
}

.loader-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--bg-elevated);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    padding-top: var(--safe-top);
    background: rgba(10,10,10,0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-left: 20px;
    padding-right: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
}

.header-logo {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
}

.header-search {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.header-search:active {
    transform: scale(0.92);
    background: var(--bg-elevated);
}

.header-search svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
}

.search-bar {
    position: fixed;
    top: var(--header-height);
    left: 0;
    right: 0;
    padding: 12px 20px;
    background: var(--bg-dark);
    z-index: 99;
    transform: translateY(-100%);
    opacity: 0;
    transition: var(--transition);
}

.search-bar.active {
    transform: translateY(0);
    opacity: 1;
}

.search-input {
    width: 100%;
    height: 46px;
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--radius-lg);
    padding: 0 18px;
    font-size: 1rem;
    color: var(--text-primary);
    outline: none;
    transition: var(--transition);
}

.search-input:focus {
    border-color: var(--primary);
    background: var(--bg-elevated);
}

.search-input::placeholder {
    color: var(--text-muted);
}

.main-container {
    position: fixed;
    top: var(--header-height);
    left: 0;
    right: 0;
    bottom: var(--nav-height);
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
}

.main-container.search-open {
    top: calc(var(--header-height) + 70px);
}

.view {
    display: none;
    padding: 24px 20px;
    min-height: 100%;
}

.view.active {
    display: block;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 18px;
}

.series-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
}

.series-card {
    cursor: pointer;
    transition: transform 0.2s ease;
    position: relative;
}

.series-card:active {
    transform: scale(0.96);
}

.series-poster {
    position: relative;
    width: 100%;
    aspect-ratio: 2/3;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: linear-gradient(145deg, var(--bg-surface), var(--bg-elevated));
    margin-bottom: 10px;
}

.series-poster img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.series-poster img.loaded {
    opacity: 1;
}

.poster-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
    color: var(--text-secondary);
    font-size: 0.7rem;
    font-weight: 700;
    text-align: center;
    padding: 10px;
    text-transform: uppercase;
}

.series-name {
    font-size: 0.9rem;
    font-weight: 600;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.3;
    margin-bottom: 4px;
}

.series-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.in-list-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
}

.in-list-badge svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 3;
    fill: none;
}

.detail-view {
    position: fixed;
    inset: 0;
    background: var(--bg-dark);
    z-index: 200;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.detail-view.active {
    transform: translateX(0);
}

.detail-scroll {
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 100px;
}

.detail-header {
    position: relative;
    width: 100%;
    aspect-ratio: 16/10;
    background: linear-gradient(145deg, var(--bg-surface), var(--bg-elevated));
}

.detail-backdrop {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.detail-backdrop.loaded {
    opacity: 1;
}

.detail-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, transparent 0%, rgba(10,10,10,0.5) 50%, var(--bg-dark) 100%);
}

.detail-back {
    position: absolute;
    top: calc(var(--safe-top) + 14px);
    left: 14px;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.08);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: var(--transition);
}

.detail-back:active {
    transform: scale(0.9);
    background: rgba(0,0,0,0.7);
}

.detail-back svg {
    width: 22px;
    height: 22px;
    stroke: currentColor;
    stroke-width: 2.5;
    fill: none;
}

.detail-content {
    padding: 24px 20px;
}

.detail-series-name {
    font-size: 1.7rem;
    font-weight: 800;
    margin-bottom: 12px;
    line-height: 1.15;
}

.detail-meta {
    display: flex;
    gap: 16px;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 24px;
}

.detail-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 32px;
}

.btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 15px 24px;
    border-radius: var(--radius-md);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: var(--transition);
}

.btn:active {
    transform: scale(0.97);
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:active {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-elevated);
    color: white;
    border: 1px solid rgba(255,255,255,0.1);
}

.btn-secondary.active {
    background: rgba(229, 9, 20, 0.2);
    border-color: var(--primary);
    color: var(--primary);
}

.btn svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
}

.btn-secondary svg {
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
}

.season-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
    scrollbar-width: none;
}

.season-tabs::-webkit-scrollbar {
    display: none;
}

.season-tab {
    flex: 0 0 auto;
    padding: 11px 20px;
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.season-tab.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.season-tab:active {
    transform: scale(0.95);
}

.episode-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.episode-item {
    display: flex;
    gap: 14px;
    padding: 14px;
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
}

.episode-item:active {
    background: var(--bg-elevated);
    transform: scale(0.98);
}

.ep-thumb {
    position: relative;
    flex: 0 0 120px;
    aspect-ratio: 16/9;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: linear-gradient(145deg, var(--bg-card), var(--bg-elevated));
}

.ep-thumb img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.ep-thumb img.loaded {
    opacity: 1;
}

.ep-thumb-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(145deg, #1a1a1a, #222);
    color: var(--text-muted);
    font-size: 0.8rem;
    font-weight: 700;
}

.ep-number {
    position: absolute;
    bottom: 6px;
    right: 6px;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
}

.ep-play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 34px;
    height: 34px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ep-play-icon svg {
    width: 12px;
    height: 12px;
    fill: white;
    margin-left: 2px;
}

.ep-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
}

.ep-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.ep-subtitle {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.player-overlay {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 300;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.player-overlay.active {
    transform: translateX(0);
}

.player-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 16px 20px;
    padding-top: calc(var(--safe-top) + 16px);
    background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 16px;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.player-header.hidden {
    opacity: 0;
    pointer-events: none;
}

.player-close {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.player-close:active {
    transform: scale(0.9);
    background: rgba(255,255,255,0.2);
}

.player-close svg {
    width: 22px;
    height: 22px;
    stroke: currentColor;
    stroke-width: 2.5;
    fill: none;
}

.player-info {
    flex: 1;
}

.player-series-name {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.player-ep-title {
    font-size: 1rem;
    font-weight: 600;
    color: white;
}

.player-video-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
}

.player-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
}

.player-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.player-loading .loader-spinner {
    width: 48px;
    height: 48px;
}

.player-loading-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.player-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    display: none;
}

.player-error.active {
    display: block;
}

.player-error-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.player-error-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.player-error-btn {
    padding: 12px 24px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
}

/* Swipe indicator */
.swipe-indicator {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60px;
    background: rgba(255,255,255,0.3);
    border-radius: 0 4px 4px 0;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.player-overlay .swipe-indicator,
.detail-view .swipe-indicator {
    opacity: 1;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 24px;
    text-align: center;
}

.empty-state svg {
    width: 64px;
    height: 64px;
    stroke: var(--text-muted);
    stroke-width: 1.5;
    fill: none;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.empty-state-text {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: var(--nav-height);
    padding-bottom: var(--safe-bottom);
    background: rgba(15,15,15,0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255,255,255,0.04);
    display: flex;
    align-items: center;
    justify-content: space-around;
    z-index: 100;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 20px;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.nav-item.active {
    color: var(--text-primary);
}

.nav-item svg {
    width: 22px;
    height: 22px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
}

.nav-item.active svg {
    stroke: var(--primary);
}

.nav-label {
    font-size: 0.68rem;
    font-weight: 600;
}

.nav-badge {
    position: absolute;
    top: 4px;
    right: 12px;
    min-width: 18px;
    height: 18px;
    background: var(--primary);
    border-radius: 9px;
    font-size: 0.65rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
}

.toast {
    position: fixed;
    bottom: calc(var(--nav-height) + 20px);
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--bg-elevated);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--text-primary);
    padding: 14px 28px;
    border-radius: var(--radius-lg);
    font-size: 0.9rem;
    font-weight: 500;
    z-index: 500;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

@media (min-width: 400px) {
    .series-grid { gap: 16px; }
    .ep-thumb { flex: 0 0 130px; }
}

@media (max-width: 350px) {
    .series-grid { grid-template-columns: repeat(2, 1fr); }
    .ep-thumb { flex: 0 0 100px; }
}

@media (orientation: landscape) {
    .player-header { padding-left: 60px; padding-right: 60px; }
}
</style>
</head>
<body>

<div class="loader" id="loader">
    <div class="loader-logo">SERIES+</div>
    <div class="loader-spinner"></div>
</div>

<header class="header">
    <div class="header-logo">SERIES+</div>
    <button class="header-search" id="searchBtn">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
    </button>
</header>

<div class="search-bar" id="searchBar">
    <input type="text" class="search-input" id="searchInput" placeholder="Buscar series...">
</div>

<main class="main-container" id="mainContainer">
    <div class="view active" id="homeView">
        <h2 class="section-title">Series</h2>
        <div class="series-grid" id="seriesGrid"></div>
    </div>
    
    <div class="view" id="myListView">
        <h2 class="section-title">Mi Lista</h2>
        <div class="series-grid" id="myListGrid"></div>
        <div class="empty-state" id="myListEmpty" style="display: none;">
            <svg viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v14a2 2 0 01-2 2z"/>
                <path d="M12 8v8M8 12h8"/>
            </svg>
            <div class="empty-state-title">Tu lista está vacía</div>
            <div class="empty-state-text">Agrega series para verlas después</div>
        </div>
    </div>
</main>

<div class="detail-view" id="detailView">
    <div class="swipe-indicator"></div>
    <div class="detail-scroll">
        <div class="detail-header">
            <img class="detail-backdrop" id="detailBackdrop" src="" alt="">
            <div class="detail-gradient"></div>
            <button class="detail-back" id="detailBack">
                <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </button>
        </div>
        
        <div class="detail-content">
            <h1 class="detail-series-name" id="detailSeriesName"></h1>
            <div class="detail-meta" id="detailMeta"></div>
            
            <div class="detail-actions">
                <button class="btn btn-primary" id="playBtn">
                    <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
                    <span>Reproducir</span>
                </button>
                <button class="btn btn-secondary" id="addListBtn">
                    <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Mi Lista</span>
                </button>
            </div>
            
            <div class="season-tabs" id="seasonTabs"></div>
            <div class="episode-list" id="episodeList"></div>
        </div>
    </div>
</div>

<div class="player-overlay" id="playerOverlay">
    <div class="swipe-indicator"></div>
    <div class="player-header" id="playerHeader">
        <button class="player-close" id="playerClose">
            <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div class="player-info">
            <div class="player-series-name" id="playerSeriesName"></div>
            <div class="player-ep-title" id="playerEpTitle"></div>
        </div>
    </div>
    
    <div class="player-video-container" id="playerContainer">
        <video class="player-video" id="playerVideo" controls playsinline></video>
        
        <div class="player-loading" id="playerLoading">
            <div class="loader-spinner"></div>
            <div class="player-loading-text">Cargando video...</div>
        </div>
        
        <div class="player-error" id="playerError">
            <div class="player-error-title">Error de reproducción</div>
            <div class="player-error-text">No se pudo cargar el video</div>
            <button class="player-error-btn" id="playerRetry">Reintentar</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" data-view="home">
        <svg viewBox="0 0 24 24">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
            <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
        <span class="nav-label">Inicio</span>
    </button>
    <button class="nav-item" data-view="search">
        <svg viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="7"/>
            <path d="M21 21l-4.35-4.35"/>
        </svg>
        <span class="nav-label">Buscar</span>
    </button>
    <button class="nav-item" data-view="mylist">
        <svg viewBox="0 0 24 24">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v14a2 2 0 01-2 2z"/>
            <path d="M9 9h6M9 13h6M9 17h4"/>
        </svg>
        <span class="nav-label">Mi Lista</span>
        <span class="nav-badge" id="listBadge" style="display: none;">0</span>
    </button>
</nav>

<div class="toast" id="toast"></div>

<script>
class SeriesApp {
    constructor() {
        this.rawData = [];
        this.seriesMap = {};
        this.currentSeries = null;
        this.currentSeason = null;
        this.currentEpisode = null;
        this.currentView = 'home';
        this.myList = JSON.parse(localStorage.getItem('myList')) || [];
        this.isSearchOpen = false;
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.headerTimeout = null;
        
        this.init();
    }
    
    async init() {
        this.cacheElements();
        this.bindEvents();
        await this.loadData();
        this.updateListBadge();
        this.hideLoader();
    }
    
    cacheElements() {
        this.loader = document.getElementById('loader');
        this.searchBtn = document.getElementById('searchBtn');
        this.searchBar = document.getElementById('searchBar');
        this.searchInput = document.getElementById('searchInput');
        this.mainContainer = document.getElementById('mainContainer');
        this.homeView = document.getElementById('homeView');
        this.myListView = document.getElementById('myListView');
        this.seriesGrid = document.getElementById('seriesGrid');
        this.myListGrid = document.getElementById('myListGrid');
        this.myListEmpty = document.getElementById('myListEmpty');
        this.detailView = document.getElementById('detailView');
        this.detailBack = document.getElementById('detailBack');
        this.detailBackdrop = document.getElementById('detailBackdrop');
        this.detailSeriesName = document.getElementById('detailSeriesName');
        this.detailMeta = document.getElementById('detailMeta');
        this.playBtn = document.getElementById('playBtn');
        this.addListBtn = document.getElementById('addListBtn');
        this.seasonTabs = document.getElementById('seasonTabs');
        this.episodeList = document.getElementById('episodeList');
        this.playerOverlay = document.getElementById('playerOverlay');
        this.playerHeader = document.getElementById('playerHeader');
        this.playerClose = document.getElementById('playerClose');
        this.playerVideo = document.getElementById('playerVideo');
        this.playerContainer = document.getElementById('playerContainer');
        this.playerSeriesName = document.getElementById('playerSeriesName');
        this.playerEpTitle = document.getElementById('playerEpTitle');
        this.playerLoading = document.getElementById('playerLoading');
        this.playerError = document.getElementById('playerError');
        this.playerRetry = document.getElementById('playerRetry');
        this.navItems = document.querySelectorAll('.nav-item');
        this.listBadge = document.getElementById('listBadge');
        this.toast = document.getElementById('toast');
    }
    
    bindEvents() {
        this.searchBtn.addEventListener('click', () => this.toggleSearch());
        this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
        this.detailBack.addEventListener('click', () => this.closeDetail());
        this.playBtn.addEventListener('click', () => this.playFirstEpisode());
        this.addListBtn.addEventListener('click', () => this.toggleSeriesInList());
        this.playerClose.addEventListener('click', () => this.closePlayer());
        this.playerRetry.addEventListener('click', () => this.retryPlay());
        
        this.playerVideo.addEventListener('loadstart', () => this.showPlayerLoading(true));
        this.playerVideo.addEventListener('canplay', () => this.showPlayerLoading(false));
        this.playerVideo.addEventListener('error', () => this.showPlayerError());
        this.playerVideo.addEventListener('ended', () => this.onVideoEnded());
        
        // Toggle header visibility on tap
        this.playerContainer.addEventListener('click', () => this.togglePlayerHeader());
        
        // Swipe gestures for detail view
        this.detailView.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
        this.detailView.addEventListener('touchend', (e) => this.handleDetailSwipe(e), { passive: true });
        
        // Swipe gestures for player
        this.playerOverlay.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
        this.playerOverlay.addEventListener('touchend', (e) => this.handlePlayerSwipe(e), { passive: true });
        
        this.navItems.forEach(item => {
            item.addEventListener('click', (e) => this.handleNav(e));
        });
    }
    
    handleTouchStart(e) {
        this.touchStartX = e.touches[0].clientX;
        this.touchStartY = e.touches[0].clientY;
    }
    
    handleDetailSwipe(e) {
        const deltaX = e.changedTouches[0].clientX - this.touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].clientY - this.touchStartY);
        
        // Swipe desde borde izquierdo (primeros 50px) hacia derecha
        if (this.touchStartX < 50 && deltaX > 80 && deltaY < 100) {
            this.closeDetail();
        }
    }
    
    handlePlayerSwipe(e) {
        const deltaX = e.changedTouches[0].clientX - this.touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].clientY - this.touchStartY);
        
        // Swipe desde borde izquierdo hacia derecha
        if (this.touchStartX < 50 && deltaX > 80 && deltaY < 100) {
            this.closePlayer();
        }
    }
    
    togglePlayerHeader() {
        clearTimeout(this.headerTimeout);
        
        if (this.playerHeader.classList.contains('hidden')) {
            this.playerHeader.classList.remove('hidden');
            this.headerTimeout = setTimeout(() => {
                if (!this.playerVideo.paused) {
                    this.playerHeader.classList.add('hidden');
                }
            }, 3000);
        } else {
            this.playerHeader.classList.add('hidden');
        }
    }
    
    loadImage(img, src) {
        if (!src) return;
        const image = new Image();
        image.onload = () => {
            img.src = src;
            img.classList.add('loaded');
        };
        image.src = src;
    }
    
    async loadData() {
        try {
            const data = [
                {"logo serie": "https://image.tmdb.org/t/p/w500/7PRddO7z7mcPi21nMbDjM76XyXA.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/8ibBnOpAiemXEIkjpNMxv3FPPqP.jpg", "series": "Black Mirror", "season": "1", "ep": 1, "title": "The National Anthem", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/7PRddO7z7mcPi21nMbDjM76XyXA.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/eCeFqoEOLnF0fvoh9gH5uGIsjgp.jpg", "series": "Black Mirror", "season": "1", "ep": 2, "title": "Fifteen Million Merits", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/7PRddO7z7mcPi21nMbDjM76XyXA.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/lOKjaL7nzCbDpD5RLtqDGbTqPwG.jpg", "series": "Black Mirror", "season": "2", "ep": 1, "title": "Be Right Back", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/49WJfeN0moxb9IPfGn8AIqMGskD.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/bVRQkKQoiYzz5vIAzNLR5N1fW7s.jpg", "series": "Stranger Things", "season": "1", "ep": 1, "title": "The Vanishing of Will Byers", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/49WJfeN0moxb9IPfGn8AIqMGskD.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/1mslQiNKLODiC5sS4p3FN7XMJuL.jpg", "series": "Stranger Things", "season": "1", "ep": 2, "title": "The Weirdo on Maple Street", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/ggFHVNu6YYI5L9pCfOacjizRGt.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/ydlY3iPfeOAvu8gVqrxPoMvzNCn.jpg", "series": "Breaking Bad", "season": "1", "ep": 1, "title": "Pilot", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/apbrbWs8M9lyOpJYU5WXrpFbk1Z.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/2lN2sH1gBhS6DJFahOJNPNnXxbR.jpg", "series": "Dark", "season": "1", "ep": 1, "title": "Secrets", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"},
                {"logo serie": "https://image.tmdb.org/t/p/w500/7vjaCdMw15FEbXyLQTVa04URsPm.jpg", "logo ep": "https://image.tmdb.org/t/p/w300/exirQwdFU7Mu0xmQNzxqwN5bFJV.jpg", "series": "The Witcher", "season": "1", "ep": 1, "title": "The End's Beginning", "url": "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"}
            ];
            
            this.rawData = data;
            this.processData();
            this.renderSeriesGrid();
        } catch (error) {
            this.showToast('Error al cargar datos');
        }
    }
    
    processData() {
        this.seriesMap = {};
        this.rawData.forEach(item => {
            const name = item.series;
            const season = item.season.toString();
            if (!this.seriesMap[name]) {
                this.seriesMap[name] = { name, logoSerie: item["logo serie"], seasons: {} };
            }
            if (!this.seriesMap[name].seasons[season]) {
                this.seriesMap[name].seasons[season] = [];
            }
            this.seriesMap[name].seasons[season].push({
                ep: item.ep, title: item.title, logoEp: item["logo ep"], url: item.url
            });
        });
        Object.values(this.seriesMap).forEach(s => {
            Object.values(s.seasons).forEach(eps => eps.sort((a, b) => a.ep - b.ep));
        });
    }
    
    renderSeriesGrid() {
        this.seriesGrid.innerHTML = '';
        Object.values(this.seriesMap).forEach(s => this.seriesGrid.appendChild(this.createSeriesCard(s)));
    }
    
    renderMyList() {
        this.myListGrid.innerHTML = '';
        if (this.myList.length === 0) {
            this.myListEmpty.style.display = 'flex';
            return;
        }
        this.myListEmpty.style.display = 'none';
        this.myList.forEach(name => {
            const s = this.seriesMap[name];
            if (s) this.myListGrid.appendChild(this.createSeriesCard(s, true));
        });
    }
    
    createSeriesCard(series, inListView = false) {
        const card = document.createElement('article');
        card.className = 'series-card';
        const sCount = Object.keys(series.seasons).length;
        const eCount = Object.values(series.seasons).reduce((a, b) => a + b.length, 0);
        const inList = this.myList.includes(series.name);
        
        card.innerHTML = `
            ${inList && !inListView ? '<div class="in-list-badge"><svg viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg></div>' : ''}
            <div class="series-poster">
                <div class="poster-placeholder">${series.name}</div>
                <img src="" alt="${series.name}">
            </div>
            <h3 class="series-name">${series.name}</h3>
            <p class="series-meta">T${sCount} · E${eCount}</p>
        `;
        this.loadImage(card.querySelector('img'), series.logoSerie);
        card.addEventListener('click', () => this.openDetail(series));
        return card;
    }
    
    openDetail(series) {
        this.currentSeries = series;
        const seasons = Object.keys(series.seasons).sort((a, b) => a - b);
        this.currentSeason = seasons[0];
        
        this.detailBackdrop.classList.remove('loaded');
        this.loadImage(this.detailBackdrop, series.logoSerie);
        this.detailSeriesName.textContent = series.name;
        
        const total = Object.values(series.seasons).reduce((a, b) => a + b.length, 0);
        this.detailMeta.innerHTML = `<span>${seasons.length} Temporada${seasons.length > 1 ? 's' : ''}</span><span>${total} Episodio${total > 1 ? 's' : ''}</span>`;
        
        this.updateAddListButton();
        this.renderSeasonTabs(seasons);
        this.renderEpisodeList();
        this.detailView.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    closeDetail() {
        this.detailView.classList.remove('active');
        document.body.style.overflow = '';
        if (this.currentView === 'mylist') this.renderMyList();
        else this.renderSeriesGrid();
    }
    
    updateAddListButton() {
        const inList = this.myList.includes(this.currentSeries.name);
        this.addListBtn.classList.toggle('active', inList);
        this.addListBtn.innerHTML = inList 
            ? '<svg viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg><span>En Mi Lista</span>'
            : '<svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg><span>Mi Lista</span>';
    }
    
    toggleSeriesInList() {
        const name = this.currentSeries.name;
        const idx = this.myList.indexOf(name);
        if (idx === -1) {
            this.myList.push(name);
            this.showToast('Agregado a Mi Lista');
        } else {
            this.myList.splice(idx, 1);
            this.showToast('Eliminado de Mi Lista');
        }
        localStorage.setItem('myList', JSON.stringify(this.myList));
        this.updateAddListButton();
        this.updateListBadge();
    }
    
    updateListBadge() {
        this.listBadge.style.display = this.myList.length > 0 ? 'flex' : 'none';
        this.listBadge.textContent = this.myList.length;
    }
    
    renderSeasonTabs(seasons) {
        this.seasonTabs.innerHTML = seasons.map(s => 
            `<button class="season-tab ${s === this.currentSeason ? 'active' : ''}" data-season="${s}">T${s}</button>`
        ).join('');
        this.seasonTabs.querySelectorAll('.season-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                this.currentSeason = tab.dataset.season;
                this.renderSeasonTabs(seasons);
                this.renderEpisodeList();
            });
        });
    }
    
    renderEpisodeList() {
        const eps = this.currentSeries.seasons[this.currentSeason];
        this.episodeList.innerHTML = eps.map((ep, i) => `
            <article class="episode-item" data-index="${i}">
                <div class="ep-thumb">
                    <div class="ep-thumb-placeholder">E${ep.ep}</div>
                    <img src="" alt="E${ep.ep}" data-src="${ep.logoEp}">
                    <span class="ep-number">E${ep.ep}</span>
                    <div class="ep-play-icon"><svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg></div>
                </div>
                <div class="ep-info">
                    <h4 class="ep-title">${ep.title}</h4>
                    <p class="ep-subtitle">T${this.currentSeason} · E${ep.ep}</p>
                </div>
            </article>
        `).join('');
        
        this.episodeList.querySelectorAll('img').forEach(img => this.loadImage(img, img.dataset.src));
        this.episodeList.querySelectorAll('.episode-item').forEach(item => {
            item.addEventListener('click', () => this.playEpisode(eps[+item.dataset.index]));
        });
    }
    
    playFirstEpisode() {
        if (!this.currentSeries) return;
        const first = Object.keys(this.currentSeries.seasons).sort()[0];
        this.playEpisode(this.currentSeries.seasons[first][0]);
    }
    
    playEpisode(ep) {
        if (!ep?.url) return this.showToast('URL no disponible');
        
        this.currentEpisode = ep;
        this.playerSeriesName.textContent = this.currentSeries.name;
        this.playerEpTitle.textContent = `T${this.currentSeason} · E${ep.ep} - ${ep.title}`;
        
        this.playerError.classList.remove('active');
        this.playerHeader.classList.remove('hidden');
        this.showPlayerLoading(true);
        
        this.playerOverlay.classList.add('active');
        this.playerVideo.src = ep.url;
        this.playerVideo.load();
        this.playerVideo.play().catch(() => {});
        
        // Auto-hide header
        this.headerTimeout = setTimeout(() => this.playerHeader.classList.add('hidden'), 3000);
    }
    
    closePlayer() {
        clearTimeout(this.headerTimeout);
        this.playerVideo.pause();
        this.playerVideo.src = '';
        this.playerOverlay.classList.remove('active');
        // Vuelve al detalle, NO cierra todo
    }
    
    showPlayerLoading(show) {
        this.playerLoading.style.display = show ? 'flex' : 'none';
    }
    
    showPlayerError() {
        this.showPlayerLoading(false);
        this.playerError.classList.add('active');
    }
    
    retryPlay() {
        if (!this.currentEpisode) return;
        this.playerError.classList.remove('active');
        this.showPlayerLoading(true);
        this.playerVideo.load();
        this.playerVideo.play().catch(() => {});
    }
    
    onVideoEnded() {
        const eps = this.currentSeries.seasons[this.currentSeason];
        const idx = eps.findIndex(e => e.ep === this.currentEpisode.ep);
        if (idx < eps.length - 1) {
            this.showToast(`Siguiente: E${eps[idx + 1].ep}`);
            setTimeout(() => this.playEpisode(eps[idx + 1]), 2000);
        } else {
            this.showToast('Fin de la temporada');
            setTimeout(() => this.closePlayer(), 2000);
        }
    }
    
    toggleSearch() {
        this.isSearchOpen = !this.isSearchOpen;
        this.searchBar.classList.toggle('active', this.isSearchOpen);
        this.mainContainer.classList.toggle('search-open', this.isSearchOpen);
        if (this.isSearchOpen) this.searchInput.focus();
        else { this.searchInput.value = ''; this.renderSeriesGrid(); }
    }
    
    handleSearch(q) {
        q = q.toLowerCase().trim();
        if (!q) return this.renderSeriesGrid();
        
        const filtered = Object.values(this.seriesMap).filter(s => s.name.toLowerCase().includes(q));
        this.seriesGrid.innerHTML = '';
        
        if (!filtered.length) {
            this.seriesGrid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><p class="empty-state-text">Sin resultados para "${q}"</p></div>`;
            return;
        }
        filtered.forEach(s => this.seriesGrid.appendChild(this.createSeriesCard(s)));
    }
    
    handleNav(e) {
        const view = e.currentTarget.dataset.view;
        this.navItems.forEach(n => n.classList.remove('active'));
        e.currentTarget.classList.add('active');
        
        if (view === 'search') return this.toggleSearch();
        
        if (this.isSearchOpen) {
            this.isSearchOpen = false;
            this.searchBar.classList.remove('active');
            this.mainContainer.classList.remove('search-open');
            this.searchInput.value = '';
        }
        
        this.currentView = view;
        this.homeView.classList.remove('active');
        this.myListView.classList.remove('active');
        
        if (view === 'home') { this.homeView.classList.add('active'); this.renderSeriesGrid(); }
        else if (view === 'mylist') { this.myListView.classList.add('active'); this.renderMyList(); }
        
        this.mainContainer.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    showToast(msg) {
        this.toast.textContent = msg;
        this.toast.classList.add('show');
        setTimeout(() => this.toast.classList.remove('show'), 2500);
    }
    
    hideLoader() {
        setTimeout(() => this.loader.classList.add('hidden'), 500);
    }
}

document.addEventListener('DOMContentLoaded', () => window.app = new SeriesApp());
window.addEventListener('online', () => window.app?.showToast('Conectado'));
window.addEventListener('offline', () => window.app?.showToast('Sin conexión'));
</script>

</body>
</html>
