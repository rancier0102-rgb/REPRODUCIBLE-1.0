<!DOCTYPE html> 
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Latino VOD+ - Plataforma Multi-Fuente</title>
<style>
/* ESTILOS BASE */
:root {
    --primary-color: #e50914;
    --secondary-color: #46d369;
    --background-dark: #141414;
    --background-card: #181818;
    --background-secondary: #222;
    --text-light: #fff;
    --muted: #b3b3b3;
    --radius: 8px;
    --transition: 0.25s ease;
    --focus-shadow: 0 0 25px rgba(229, 9, 20, 0.9);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--background-dark);
    color: var(--text-light);
    overflow-x: hidden;
}

/* Loader mejorado */
.loader {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 1000;
    background: rgba(20, 20, 20, 0.95);
    padding: 30px;
    border-radius: 15px;
    min-width: 300px;
}

.loader-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(229, 9, 20, 0.3);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-text {
    color: var(--text-light);
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.loader-progress {
    margin-top: 10px;
    color: var(--muted);
    font-size: 0.9rem;
}

.loader-sources {
    margin-top: 20px;
    text-align: left;
}

.loader-source-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px;
    margin: 5px 0;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.05);
}

.loader-source-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--muted);
}

.loader-source-status.loading {
    background: #ffa500;
    animation: pulse 1s infinite;
}

.loader-source-status.success {
    background: var(--secondary-color);
}

.loader-source-status.error {
    background: #ff4444;
}

.loader.hidden {
    display: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* HEADER MEJORADO */
header {
    padding: 15px 40px;
    background: rgba(0,0,0,0.9);
    position: sticky;
    top: 0;
    display: flex;
    gap: 15px;
    align-items: center;
    z-index: 10;
    backdrop-filter: blur(10px);
    flex-wrap: wrap;
}

.logo { 
    font-weight: bold; 
    font-size: 1.8rem; 
    color: var(--primary-color);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

/* Search bar */
.search-container {
    flex: 1;
    max-width: 400px;
    margin: 0 auto;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 8px 40px 8px 15px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 25px;
    color: var(--text-light);
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    background: rgba(255,255,255,0.15);
    border-color: var(--primary-color);
}

.search-clear {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 5px;
    display: none;
}

.search-clear.visible {
    display: block;
}

/* SOURCE SELECTOR */
.source-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px 40px;
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    overflow-x: auto;
    scrollbar-width: thin;
}

.source-label {
    color: var(--muted);
    font-size: 0.9rem;
    margin-right: 10px;
    white-space: nowrap;
}

.source-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    color: var(--text-light);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
}

.source-btn:hover {
    background: rgba(255,255,255,0.2);
    border-color: var(--primary-color);
}

.source-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.source-btn .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--secondary-color);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: bold;
}

/* CATEGORY FILTER */
.category-filter {
    display: flex;
    gap: 10px;
    padding: 10px 40px;
    background: rgba(0,0,0,0.3);
    overflow-x: auto;
    scrollbar-width: thin;
}

.category-btn {
    padding: 6px 14px;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 15px;
    color: var(--muted);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.category-btn:hover {
    color: var(--text-light);
    border-color: var(--primary-color);
}

.category-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* Status indicators */
.status-bar {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-left: auto;
}

.status-indicator {
    padding: 5px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-indicator.connected::before {
    content: "";
    width: 8px;
    height: 8px;
    background: #46d369;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.movie-count {
    color: var(--muted);
    font-size: 0.85rem;
}

/* MAIN CONTENT */
.main-content {
    padding: 20px 0;
    min-height: 500px;
}

/* PROVIDER SECTIONS */
.provider-section {
    margin-bottom: 50px;
    opacity: 0;
    animation: fadeIn 0.5s ease-out forwards;
}

.provider-header {
    padding: 0 40px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-left: 4px solid var(--primary-color);
}

.provider-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--text-light);
}

.provider-info {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-left: auto;
}

.provider-count {
    color: var(--muted);
    font-size: 0.9rem;
}

.provider-status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    background: rgba(70, 211, 105, 0.2);
    color: var(--secondary-color);
}

.provider-status.error {
    background: rgba(255, 68, 68, 0.2);
    color: #ff4444;
}

/* YEAR SECTIONS */
.year-section {
    margin-bottom: 40px;
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.year-header {
    padding: 0 40px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.year-title {
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text-light);
}

.year-count {
    color: var(--muted);
    font-size: 0.85rem;
}

/* CAROUSEL */
.carousel-container {
    position: relative;
    padding: 0 40px;
}

.carousel-track {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    padding: 10px 0;
}

.carousel-track::-webkit-scrollbar {
    display: none;
}

.carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 80%;
    background: linear-gradient(90deg, rgba(20,20,20,0.95), transparent);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 5;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.carousel-nav.prev {
    left: 0;
}

.carousel-nav.next {
    right: 0;
    background: linear-gradient(-90deg, rgba(20,20,20,0.95), transparent);
}

.carousel-container:hover .carousel-nav {
    opacity: 1;
}

/* MOVIE CARDS */
.movie-card {
    flex: 0 0 150px;
    background: transparent;
    border-radius: 5px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    border: 2px solid transparent;
}

.movie-card.skeleton {
    background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    height: 225px;
}

.movie-card img { 
    width: 100%; 
    height: auto;
    aspect-ratio: 2/3;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.movie-card img.loaded {
    opacity: 1;
}

/* Source badge on card */
.movie-source-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 3px 8px;
    background: rgba(0,0,0,0.8);
    color: white;
    font-size: 0.65rem;
    border-radius: 10px;
    font-weight: bold;
    z-index: 2;
}

.movie-card-title { 
    padding: 8px; 
    font-size: 0.8rem; 
    font-weight: 500;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.9));
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.movie-card:hover {
    transform: scale(1.05);
    z-index: 3;
}

.movie-card:hover .movie-card-title {
    opacity: 1;
}

/* Play overlay */
.play-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.movie-card:hover .play-overlay {
    opacity: 1;
}

.play-icon {
    width: 50px;
    height: 50px;
    background: rgba(229, 9, 20, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.play-icon::after {
    content: "▶";
    color: white;
    font-size: 1.2rem;
    margin-left: 3px;
}

/* MOVIE DETAIL OVERLAY */
.movie-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--background-dark);
    z-index: 100;
    overflow-y: auto;
    animation: slideIn 0.3s ease-out;
}

.movie-banner {
    position: relative;
    height: 500px;
    overflow: hidden;
    margin-bottom: 20px;
}

.movie-banner-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    filter: brightness(0.4) blur(5px);
    transform: scale(1.1);
}

.movie-banner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.2) 0%,
        rgba(0,0,0,0.6) 60%,
        var(--background-dark) 100%
    );
}

.movie-banner-content {
    position: relative;
    height: 100%;
    display: flex;
    align-items: flex-start;
    padding: 80px 60px 40px;
    z-index: 2;
    gap: 40px;
}

.movie-poster {
    width: 250px;
    height: 375px;
    object-fit: cover;
    border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.movie-details {
    flex: 1;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.movie-header {
    font-size: 3rem;
    font-weight: 700;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
    margin-bottom: 15px;
    line-height: 1.1;
}

.movie-metadata {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    font-size: 1.1rem;
    opacity: 0.9;
    align-items: center;
}

.source-tag {
    padding: 4px 10px;
    background: var(--primary-color);
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: bold;
}

.movie-description {
    font-size: 1.1rem;
    line-height: 1.6;
    max-width: 800px;
    opacity: 0.9;
    margin-bottom: 30px;
}

.movie-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-play {
    padding: 15px 40px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 30px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-play:hover {
    background: #ff0a16;
    transform: scale(1.05);
}

.btn-play::before {
    content: "▶";
    font-size: 1rem;
}

/* SETTINGS MODAL */
.settings-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 200;
    padding: 40px;
    overflow-y: auto;
}

.settings-content {
    max-width: 800px;
    margin: 0 auto;
    background: var(--background-card);
    border-radius: 15px;
    padding: 30px;
}

.settings-header {
    font-size: 1.5rem;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.source-manager {
    margin-bottom: 30px;
}

.source-list {
    margin-top: 20px;
}

.source-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 10px;
}

.source-item.disabled {
    opacity: 0.5;
}

.source-toggle {
    width: 50px;
    height: 25px;
    background: rgba(255,255,255,0.2);
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.source-toggle.active {
    background: var(--secondary-color);
}

.source-toggle::after {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 21px;
    height: 21px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.source-toggle.active::after {
    transform: translateX(25px);
}

.source-details {
    flex: 1;
}

.source-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.source-url {
    color: var(--muted);
    font-size: 0.85rem;
    word-break: break-all;
}

.source-stats {
    text-align: right;
}

.add-source-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.add-source-btn:hover {
    background: #ff0a16;
}

/* Back button */
.back-button {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(34, 34, 34, 0.95);
    color: var(--text-light);
    border: 2px solid transparent;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    display: none;
    z-index: 201;
    transition: all 0.3s ease;
}

.back-button.visible {
    display: flex;
    align-items: center;
    gap: 8px;
}

.close {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 2.5rem;
    cursor: pointer;
    color: white;
    z-index: 201;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close:hover {
    background: var(--primary-color);
    transform: rotate(90deg);
}

/* Error message */
.error-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(229, 9, 20, 0.95);
    color: white;
    padding: 20px 30px;
    border-radius: 10px;
    z-index: 1000;
    display: none;
}

.error-message.show {
    display: block;
}

.empty-state {
    text-align: center;
    padding: 100px 20px;
    color: var(--muted);
}

/* Settings button */
.settings-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: var(--text-light);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.settings-btn:hover {
    background: rgba(255,255,255,0.2);
}

/* Responsive */
@media (max-width: 768px) {
    header {
        padding: 15px;
    }
    
    .source-selector,
    .category-filter {
        padding: 10px 15px;
    }
    
    .year-header,
    .carousel-container,
    .provider-header {
        padding: 0 20px;
    }
    
    .movie-card {
        flex: 0 0 110px;
    }
    
    .carousel-nav {
        display: none;
    }
    
    .movie-banner-content {
        flex-direction: column;
        padding: 40px 20px;
    }
    
    .movie-poster {
        width: 150px;
        height: 225px;
    }
    
    .movie-header {
        font-size: 1.8rem;
    }
}
</style>
</head>
<body>

<div class="loader" id="loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">Cargando películas...</div>
    <div class="loader-progress" id="loaderProgress"></div>
    <div class="loader-sources" id="loaderSources"></div>
</div>

<header>
    <div class="logo">MOVIES+</div>
    
    <div class="search-container">
        <input type="text" 
               class="search-input" 
               id="searchInput" 
               placeholder="Buscar películas...">
        <button class="search-clear" id="searchClear">✕</button>
    </div>
    
    <div class="status-bar">
        <div class="movie-count" id="movieCount">0 películas</div>
        <div class="status-indicator connected" id="statusIndicator">
            <span id="statusText">Conectado</span>
        </div>
        <button class="settings-btn" id="settingsBtn">⚙️</button>
    </div>
</header>

<!-- Source selector -->
<div class="source-selector" id="sourceSelector">
    <span class="source-label">Fuentes:</span>
    <button class="source-btn active" data-source="all">
        Todas
        <span class="badge" id="allCount">0</span>
    </button>
</div>

<!-- Category filter -->
<div class="category-filter" id="categoryFilter">
    <button class="category-btn active" data-category="all">Todas</button>
    <button class="category-btn" data-category="accion">Acción</button>
    <button class="category-btn" data-category="comedia">Comedia</button>
    <button class="category-btn" data-category="drama">Drama</button>
    <button class="category-btn" data-category="terror">Terror</button>
    <button class="category-btn" data-category="scifi">Sci-Fi</button>
    <button class="category-btn" data-category="romance">Romance</button>
    <button class="category-btn" data-category="animacion">Animación</button>
</div>

<button class="back-button" id="backButton">
    <span>←</span>
    <span>Volver</span>
</button>

<main class="main-content" id="mainContent">
    <!-- El contenido se cargará dinámicamente aquí -->
</main>

<!-- MOVIE DETAIL OVERLAY -->
<div id="movieOverlay" class="movie-overlay">
    <span class="close" id="closeButton">×</span>
    
    <div class="movie-banner">
        <div class="movie-banner-bg" id="movieBannerBg"></div>
        <div class="movie-banner-overlay"></div>
        <div class="movie-banner-content">
            <img class="movie-poster" id="moviePoster" src="" alt="">
            <div class="movie-details">
                <h1 class="movie-header" id="movieTitle">MOVIE TITLE</h1>
                <div class="movie-metadata">
                    <span id="movieYear">2024</span>
                    <span>•</span>
                    <span id="movieCategory">Película</span>
                    <span>•</span>
                    <span class="source-tag" id="movieSource">Fuente</span>
                </div>
                <p class="movie-description" id="movieDescription">
                    Descripción de la película...
                </p>
                <div class="movie-actions">
                    <button class="btn-play" id="playButton">Reproducir</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="settings-modal" id="settingsModal">
    <div class="settings-content">
        <h2 class="settings-header">⚙️ Configuración de Fuentes</h2>
        
        <div class="source-manager">
            <h3>Gestionar Fuentes de Películas</h3>
            <div class="source-list" id="sourceList">
                <!-- Las fuentes se cargarán aquí dinámicamente -->
            </div>
            <button class="add-source-btn" id="addSourceBtn">+ Agregar Nueva Fuente</button>
        </div>
        
        <button class="close" onclick="document.getElementById('settingsModal').style.display='none'">×</button>
    </div>
</div>

<!-- Error message -->
<div class="error-message" id="errorMessage">
    Error cargando el contenido
</div>

<script>
/* ========================================
   MULTI-SOURCE MOVIES PLATFORM
   Sistema de gestión de múltiples fuentes JSON
   ======================================== */

class MultiSourceMoviesPlatform {
    constructor() {
        // Configuración de fuentes múltiples
        this.sources = [
            {
                id: 'source1',
                name: 'Servidor Principal',
                url: 'https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/peliculas1.json',
                enabled: true,
                category: 'general',
                color: '#e50914',
                movies: [],
                status: 'pending',
                lastUpdate: null
            },
            {
                id: 'source2', 
                name: 'Servidor Clásicos',
                url: 'https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/clasicos.json',
                enabled: true,
                category: 'clasicos',
                color: '#46d369',
                movies: [],
                status: 'pending',
                lastUpdate: null
            },
            {
                id: 'source3',
                name: 'Servidor Estrenos',
                url: 'https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/estrenos.json',
                enabled: true,
                category: 'estrenos',
                color: '#ffa500',
                movies: [],
                status: 'pending',
                lastUpdate: null
            }
        ];
        
        // Data management
        this.allMovies = [];
        this.moviesBySource = {};
        this.moviesByYear = {};
        this.moviesByCategory = {};
        this.filteredMovies = [];
        
        // UI State
        this.currentSource = 'all';
        this.currentCategory = 'all';
        this.currentMovie = null;
        this.isLoading = false;
        this.loadedSources = 0;
        this.failedSources = [];
        
        // Performance settings
        this.cacheEnabled = true;
        this.cacheExpiry = 3600000; // 1 hora
        this.concurrentLoads = 3; // Cargar 3 fuentes en paralelo
        
        // Initialize
        this.initializeElements();
        this.loadSources();
        this.setupEventListeners();
        this.setupIntersectionObserver();
    }
    
    initializeElements() {
        // Cache DOM elements
        this.loader = document.getElementById('loader');
        this.loaderProgress = document.getElementById('loaderProgress');
        this.loaderSources = document.getElementById('loaderSources');
        this.mainContent = document.getElementById('mainContent');
        this.movieOverlay = document.getElementById('movieOverlay');
        this.backButton = document.getElementById('backButton');
        this.closeButton = document.getElementById('closeButton');
        this.movieTitle = document.getElementById('movieTitle');
        this.movieBannerBg = document.getElementById('movieBannerBg');
        this.moviePoster = document.getElementById('moviePoster');
        this.movieYear = document.getElementById('movieYear');
        this.movieCategory = document.getElementById('movieCategory');
        this.movieSource = document.getElementById('movieSource');
        this.movieDescription = document.getElementById('movieDescription');
        this.playButton = document.getElementById('playButton');
        this.statusIndicator = document.getElementById('statusIndicator');
        this.statusText = document.getElementById('statusText');
        this.errorMessage = document.getElementById('errorMessage');
        this.searchInput = document.getElementById('searchInput');
        this.searchClear = document.getElementById('searchClear');
        this.movieCount = document.getElementById('movieCount');
        this.sourceSelector = document.getElementById('sourceSelector');
        this.categoryFilter = document.getElementById('categoryFilter');
        this.settingsBtn = document.getElementById('settingsBtn');
        this.settingsModal = document.getElementById('settingsModal');
        this.sourceList = document.getElementById('sourceList');
        this.addSourceBtn = document.getElementById('addSourceBtn');
        this.allCount = document.getElementById('allCount');
    }
    
    setupEventListeners() {
        // Navigation
        this.backButton.addEventListener('click', () => this.closeModal());
        this.closeButton.addEventListener('click', () => this.closeModal());
        
        // Search
        this.searchInput.addEventListener('input', (e) => this.handleSearch(e));
        this.searchClear.addEventListener('click', () => this.clearSearch());
        
        // Settings
        this.settingsBtn.addEventListener('click', () => this.openSettings());
        this.addSourceBtn.addEventListener('click', () => this.addNewSource());
        
        // Source selector delegation
        this.sourceSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('source-btn') || e.target.parentElement.classList.contains('source-btn')) {
                const btn = e.target.classList.contains('source-btn') ? e.target : e.target.parentElement;
                this.selectSource(btn.dataset.source);
            }
        });
        
        // Category filter delegation
        this.categoryFilter.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                this.selectCategory(e.target.dataset.category);
            }
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
    }
    
    setupIntersectionObserver() {
        this.imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    this.loadImage(img);
                    this.imageObserver.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px',
            threshold: 0.01
        });
    }
    
    async loadSources() {
        this.setLoadingState(true);
        this.updateStatus('loading', 'Cargando fuentes...');
        this.renderLoadingSources();
        
        // Cargar fuentes desde localStorage si existen
        this.loadSourcesFromStorage();
        
        // Reset counters
        this.allMovies = [];
        this.moviesBySource = {};
        this.loadedSources = 0;
        this.failedSources = [];
        
        // Cargar fuentes habilitadas en paralelo (con límite)
        const enabledSources = this.sources.filter(s => s.enabled);
        const chunks = this.chunkArray(enabledSources, this.concurrentLoads);
        
        for (const chunk of chunks) {
            await Promise.allSettled(
                chunk.map(source => this.loadSourceData(source))
            );
        }
        
        // Consolidar todas las películas
        this.consolidateMovies();
        
        // Actualizar UI
        this.updateSourceButtons();
        this.organizeMovies();
        this.renderContent();
        
        // Update status
        const status = this.failedSources.length > 0 ? 'partial' : 'connected';
        const statusText = `${this.loadedSources}/${enabledSources.length} fuentes`;
        this.updateStatus(status, statusText);
        
        this.setLoadingState(false);
    }
    
    async loadSourceData(source) {
        const sourceStatus = document.getElementById(`source-status-${source.id}`);
        
        try {
            // Update loading status
            this.updateSourceLoadingStatus(source.id, 'loading');
            
            // Check cache first
            const cached = this.getCachedSource(source.id);
            if (cached) {
                source.movies = cached;
                source.status = 'success';
                this.loadedSources++;
                this.updateSourceLoadingStatus(source.id, 'success');
                return;
            }
            
            // Fetch from URL
            const response = await fetch(source.url, {
                signal: AbortSignal.timeout(10000) // 10 second timeout
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const movies = this.parseSourceJSON(data, source);
            
            // Store movies
            source.movies = movies;
            source.status = 'success';
            source.lastUpdate = Date.now();
            this.moviesBySource[source.id] = movies;
            
            // Cache the source data
            this.setCachedSource(source.id, movies);
            
            this.loadedSources++;
            this.updateSourceLoadingStatus(source.id, 'success');
            
        } catch (error) {
            console.error(`Error loading source ${source.name}:`, error);
            source.status = 'error';
            source.movies = [];
            this.failedSources.push(source);
            this.updateSourceLoadingStatus(source.id, 'error');
        }
    }
    
    parseSourceJSON(data, source) {
        const movies = [];
        let peliculas = data.peliculas || data.movies || data;
        
        if (!Array.isArray(peliculas)) {
            peliculas = [peliculas];
        }
        
        peliculas.forEach((pelicula, index) => {
            if (pelicula.titulo && pelicula.enlace) {
                movies.push({
                    id: `${source.id}_movie_${index}`,
                    titulo: pelicula.titulo,
                    poster: pelicula.poster || this.getPlaceholderImage(pelicula.titulo),
                    ano: pelicula.ano || new Date().getFullYear(),
                    enlace: pelicula.enlace,
                    source: source.name,
                    sourceId: source.id,
                    sourceColor: source.color,
                    categoria: pelicula.categoria || pelicula.genero || source.category || 'general',
                    descripcion: pelicula.descripcion || null,
                    duracion: pelicula.duracion || null
                });
            }
        });
        
        return movies;
    }
    
    consolidateMovies() {
        this.allMovies = [];
        
        // Combinar todas las películas de todas las fuentes
        this.sources.forEach(source => {
            if (source.enabled && source.movies.length > 0) {
                this.allMovies = this.allMovies.concat(source.movies);
            }
        });
        
        // Eliminar duplicados por título y año
        const uniqueMovies = {};
        this.allMovies.forEach(movie => {
            const key = `${movie.titulo.toLowerCase()}_${movie.ano}`;
            if (!uniqueMovies[key] || movie.sourceId === 'source1') { // Priorizar source1
                uniqueMovies[key] = movie;
            }
        });
        
        this.allMovies = Object.values(uniqueMovies);
        this.updateMovieCount(this.allMovies.length);
    }
    
    organizeMovies() {
        // Organizar por año
        this.moviesByYear = {};
        this.allMovies.forEach(movie => {
            const year = movie.ano || 'Sin fecha';
            if (!this.moviesByYear[year]) {
                this.moviesByYear[year] = [];
            }
            this.moviesByYear[year].push(movie);
        });
        
        // Organizar por categoría
        this.moviesByCategory = {};
        this.allMovies.forEach(movie => {
            const category = movie.categoria || 'general';
            if (!this.moviesByCategory[category]) {
                this.moviesByCategory[category] = [];
            }
            this.moviesByCategory[category].push(movie);
        });
        
        // Ordenar películas en cada grupo
        Object.keys(this.moviesByYear).forEach(year => {
            this.moviesByYear[year].sort((a, b) => 
                a.titulo.localeCompare(b.titulo, 'es')
            );
        });
    }
    
    renderContent() {
        this.mainContent.innerHTML = '';
        
        let moviesToRender = this.allMovies;
        
        // Aplicar filtros
        if (this.currentSource !== 'all') {
            moviesToRender = moviesToRender.filter(m => m.sourceId === this.currentSource);
        }
        
        if (this.currentCategory !== 'all') {
            moviesToRender = moviesToRender.filter(m => m.categoria === this.currentCategory);
        }
        
        if (this.filteredMovies.length > 0) {
            moviesToRender = this.filteredMovies;
        }
        
        if (moviesToRender.length === 0) {
            this.renderEmptyState();
            return;
        }
        
        // Agrupar por fuente si se muestran todas
        if (this.currentSource === 'all') {
            this.renderBySource(moviesToRender);
        } else {
            this.renderByYear(moviesToRender);
        }
    }
    
    renderBySource(movies) {
        // Agrupar películas por fuente
        const moviesBySource = {};
        movies.forEach(movie => {
            if (!moviesBySource[movie.sourceId]) {
                moviesBySource[movie.sourceId] = [];
            }
            moviesBySource[movie.sourceId].push(movie);
        });
        
        // Renderizar cada fuente como sección
        this.sources.forEach(source => {
            if (source.enabled && moviesBySource[source.id]) {
                const section = this.createProviderSection(source, moviesBySource[source.id]);
                this.mainContent.appendChild(section);
            }
        });
    }
    
    renderByYear(movies) {
        // Agrupar por año
        const moviesByYear = {};
        movies.forEach(movie => {
            const year = movie.ano || 'Sin fecha';
            if (!moviesByYear[year]) {
                moviesByYear[year] = [];
            }
            moviesByYear[year].push(movie);
        });
        
        // Ordenar años
        const sortedYears = Object.keys(moviesByYear).sort((a, b) => {
            if (a === 'Sin fecha') return 1;
            if (b === 'Sin fecha') return -1;
            return parseInt(b) - parseInt(a);
        });
        
        // Renderizar cada año
        sortedYears.forEach((year, index) => {
            const section = this.createYearSection(year, moviesByYear[year], index);
            this.mainContent.appendChild(section);
        });
    }
    
    createProviderSection(source, movies) {
        const section = document.createElement('div');
        section.className = 'provider-section';
        
        // Header
        const header = document.createElement('div');
        header.className = 'provider-header';
        header.style.borderLeftColor = source.color;
        header.innerHTML = `
            <h2 class="provider-title">${source.name}</h2>
            <div class="provider-info">
                <span class="provider-count">${movies.length} películas</span>
                <span class="provider-status ${source.status}">${source.status === 'success' ? 'Activo' : 'Error'}</span>
            </div>
        `;
        section.appendChild(header);
        
        // Agrupar por año dentro de cada fuente
        const moviesByYear = {};
        movies.forEach(movie => {
            const year = movie.ano || 'Sin fecha';
            if (!moviesByYear[year]) {
                moviesByYear[year] = [];
            }
            moviesByYear[year].push(movie);
        });
        
        // Ordenar años
        const sortedYears = Object.keys(moviesByYear).sort((a, b) => {
            if (a === 'Sin fecha') return 1;
            if (b === 'Sin fecha') return -1;
            return parseInt(b) - parseInt(a);
        });
        
        // Crear subsecciones por año
        sortedYears.forEach(year => {
            const yearSection = this.createYearSection(year, moviesByYear[year], 0);
            section.appendChild(yearSection);
        });
        
        return section;
    }
    
    createYearSection(year, movies, index) {
        const section = document.createElement('div');
        section.className = 'year-section';
        section.dataset.year = year;
        
        // Header
        const header = document.createElement('div');
        header.className = 'year-header';
        header.innerHTML = `
            <h2 class="year-title">${year}</h2>
            <span class="year-count">(${movies.length})</span>
        `;
        section.appendChild(header);
        
        // Carousel
        const container = document.createElement('div');
        container.className = 'carousel-container';
        
        // Navigation buttons
        const prevBtn = document.createElement('button');
        prevBtn.className = 'carousel-nav prev';
        prevBtn.innerHTML = '‹';
        container.appendChild(prevBtn);
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'carousel-nav next';
        nextBtn.innerHTML = '›';
        container.appendChild(nextBtn);
        
        // Track
        const track = document.createElement('div');
        track.className = 'carousel-track';
        
        movies.forEach(movie => {
            const card = this.createMovieCard(movie);
            track.appendChild(card);
        });
        
        container.appendChild(track);
        section.appendChild(container);
        
        // Setup navigation
        this.setupCarouselNav(container);
        
        return section;
    }
    
    createMovieCard(movie) {
        const card = document.createElement('div');
        card.className = 'movie-card skeleton';
        card.dataset.movieId = movie.id;
        
        // Source badge
        const badge = document.createElement('div');
        badge.className = 'movie-source-badge';
        badge.style.backgroundColor = movie.sourceColor;
        badge.textContent = movie.source.substring(0, 3).toUpperCase();
        card.appendChild(badge);
        
        // Image
        const img = document.createElement('img');
        img.dataset.src = movie.poster;
        img.alt = movie.titulo;
        img.loading = 'lazy';
        card.appendChild(img);
        
        // Play overlay
        const playOverlay = document.createElement('div');
        playOverlay.className = 'play-overlay';
        playOverlay.innerHTML = '<div class="play-icon"></div>';
        card.appendChild(playOverlay);
        
        // Title
        const title = document.createElement('div');
        title.className = 'movie-card-title';
        title.textContent = movie.titulo;
        card.appendChild(title);
        
        // Click handler
        card.addEventListener('click', () => this.openMovieDetail(movie));
        
        // Observe for lazy loading
        this.imageObserver.observe(img);
        
        return card;
    }
    
    setupCarouselNav(container) {
        const track = container.querySelector('.carousel-track');
        const prevBtn = container.querySelector('.carousel-nav.prev');
        const nextBtn = container.querySelector('.carousel-nav.next');
        
        const updateButtons = () => {
            const scrollLeft = track.scrollLeft;
            const maxScroll = track.scrollWidth - track.clientWidth;
            
            prevBtn.classList.toggle('disabled', scrollLeft <= 0);
            nextBtn.classList.toggle('disabled', scrollLeft >= maxScroll - 1);
        };
        
        prevBtn.addEventListener('click', () => {
            const cardWidth = 162; // 150px + 12px gap
            track.scrollBy({ left: -cardWidth * 3, behavior: 'smooth' });
        });
        
        nextBtn.addEventListener('click', () => {
            const cardWidth = 162;
            track.scrollBy({ left: cardWidth * 3, behavior: 'smooth' });
        });
        
        track.addEventListener('scroll', updateButtons);
        updateButtons();
    }
    
    loadImage(img) {
        const src = img.dataset.src;
        if (!src || img.src === src) return;
        
        const tempImg = new Image();
        tempImg.onload = () => {
            img.src = src;
            img.classList.add('loaded');
            const card = img.closest('.movie-card');
            if (card) card.classList.remove('skeleton');
        };
        
        tempImg.onerror = () => {
            img.src = this.getPlaceholderImage(img.alt);
            img.classList.add('loaded');
            const card = img.closest('.movie-card');
            if (card) card.classList.remove('skeleton');
        };
        
        tempImg.src = src;
    }
    
    selectSource(sourceId) {
        this.currentSource = sourceId;
        
        // Update buttons
        document.querySelectorAll('.source-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.source === sourceId);
        });
        
        // Re-render content
        this.renderContent();
    }
    
    selectCategory(category) {
        this.currentCategory = category;
        
        // Update buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === category);
        });
        
        // Re-render content
        this.renderContent();
    }
    
    handleSearch(e) {
        const query = e.target.value.trim().toLowerCase();
        
        this.searchClear.classList.toggle('visible', query.length > 0);
        
        if (!query) {
            this.clearSearch();
            return;
        }
        
        // Filter movies
        this.filteredMovies = this.allMovies.filter(movie => {
            return movie.titulo.toLowerCase().includes(query) ||
                   movie.ano?.toString().includes(query) ||
                   movie.source.toLowerCase().includes(query);
        });
        
        this.renderContent();
        this.updateMovieCount(this.filteredMovies.length);
    }
    
    clearSearch() {
        this.searchInput.value = '';
        this.searchClear.classList.remove('visible');
        this.filteredMovies = [];
        this.renderContent();
        this.updateMovieCount(this.allMovies.length);
    }
    
    openMovieDetail(movie) {
        this.currentMovie = movie;
        
        this.mainContent.style.display = 'none';
        this.movieOverlay.style.display = 'block';
        this.backButton.classList.add('visible');
        
        // Setup details
        this.movieTitle.textContent = movie.titulo;
        this.movieBannerBg.style.backgroundImage = `url('${movie.poster}')`;
        this.moviePoster.src = movie.poster;
        this.moviePoster.alt = movie.titulo;
        this.movieYear.textContent = movie.ano;
        this.movieCategory.textContent = movie.categoria || 'Película';
        this.movieSource.textContent = movie.source;
        this.movieSource.style.backgroundColor = movie.sourceColor;
        this.movieDescription.textContent = movie.descripcion || 
            `Disfruta de "${movie.titulo}" desde ${movie.source}.`;
        
        this.playButton.onclick = () => this.playMovie(movie);
        
        history.pushState({ modal: true }, '', '#' + movie.id);
    }
    
    playMovie(movie) {
        if (movie.enlace && movie.enlace !== '#') {
            window.open(movie.enlace, '_blank');
        } else {
            this.showError('URL no disponible');
        }
    }
    
    closeModal() {
        this.movieOverlay.style.display = 'none';
        this.backButton.classList.remove('visible');
        this.mainContent.style.display = 'block';
        history.replaceState(null, '', window.location.pathname);
    }
    
    openSettings() {
        this.renderSourceList();
        this.settingsModal.style.display = 'block';
    }
    
    renderSourceList() {
        this.sourceList.innerHTML = '';
        
        this.sources.forEach(source => {
            const item = document.createElement('div');
            item.className = `source-item ${!source.enabled ? 'disabled' : ''}`;
            
            item.innerHTML = `
                <div class="source-toggle ${source.enabled ? 'active' : ''}" 
                     data-source-id="${source.id}"></div>
                <div class="source-details">
                    <div class="source-name">${source.name}</div>
                    <div class="source-url">${source.url}</div>
                </div>
                <div class="source-stats">
                    <div>${source.movies.length} películas</div>
                    <div style="color: ${source.status === 'success' ? '#46d369' : '#ff4444'}">
                        ${source.status === 'success' ? '✓ Activo' : '✗ Error'}
                    </div>
                </div>
            `;
            
            // Toggle handler
            const toggle = item.querySelector('.source-toggle');
            toggle.addEventListener('click', () => this.toggleSource(source.id));
            
            this.sourceList.appendChild(item);
        });
    }
    
    toggleSource(sourceId) {
        const source = this.sources.find(s => s.id === sourceId);
        if (source) {
            source.enabled = !source.enabled;
            this.saveSourcestoStorage();
            this.renderSourceList();
            
            // Reload if enabling a source
            if (source.enabled && source.movies.length === 0) {
                this.loadSourceData(source).then(() => {
                    this.consolidateMovies();
                    this.organizeMovies();
                    this.renderContent();
                });
            } else {
                this.consolidateMovies();
                this.organizeMovies();
                this.renderContent();
            }
        }
    }
    
    async addNewSource() {
        const url = prompt('Ingresa la URL del archivo JSON:');
        if (!url) return;
        
        const name = prompt('Nombre de la fuente:');
        if (!name) return;
        
        const newSource = {
            id: `source_${Date.now()}`,
            name: name,
            url: url,
            enabled: true,
            category: 'custom',
            color: this.getRandomColor(),
            movies: [],
            status: 'pending',
            lastUpdate: null
        };
        
        this.sources.push(newSource);
        this.saveSourcestoStorage();
        
        // Try to load the new source
        await this.loadSourceData(newSource);
        this.consolidateMovies();
        this.organizeMovies();
        this.renderContent();
        this.renderSourceList();
        this.updateSourceButtons();
    }
    
    updateSourceButtons() {
        // Clear existing custom source buttons
        const customButtons = this.sourceSelector.querySelectorAll('.source-btn:not([data-source="all"])');
        customButtons.forEach(btn => btn.remove());
        
        // Add buttons for each active source
        this.sources.forEach(source => {
            if (source.enabled && source.movies.length > 0) {
                const btn = document.createElement('button');
                btn.className = 'source-btn';
                btn.dataset.source = source.id;
                btn.innerHTML = `
                    ${source.name}
                    <span class="badge">${source.movies.length}</span>
                `;
                this.sourceSelector.appendChild(btn);
            }
        });
        
        // Update total count
        this.allCount.textContent = this.allMovies.length;
    }
    
    renderLoadingSources() {
        this.loaderSources.innerHTML = '';
        
        this.sources.filter(s => s.enabled).forEach(source => {
            const item = document.createElement('div');
            item.className = 'loader-source-item';
            item.innerHTML = `
                <div class="loader-source-status loading" id="source-status-${source.id}"></div>
                <div>${source.name}</div>
            `;
            this.loaderSources.appendChild(item);
        });
    }
    
    updateSourceLoadingStatus(sourceId, status) {
        const element = document.getElementById(`source-status-${sourceId}`);
        if (element) {
            element.className = `loader-source-status ${status}`;
        }
    }
    
    renderEmptyState() {
        this.mainContent.innerHTML = `
            <div class="empty-state">
                <h2>No se encontraron películas</h2>
                <p>Intenta cambiar los filtros o verificar las fuentes</p>
            </div>
        `;
    }
    
    // Storage management
    saveSourcestoStorage() {
        const sourcesData = this.sources.map(s => ({
            id: s.id,
            name: s.name,
            url: s.url,
            enabled: s.enabled,
            category: s.category,
            color: s.color
        }));
        localStorage.setItem('movieSources', JSON.stringify(sourcesData));
    }
    
    loadSourcesFromStorage() {
        try {
            const stored = localStorage.getItem('movieSources');
            if (stored) {
                const sourcesData = JSON.parse(stored);
                // Merge with default sources
                sourcesData.forEach(stored => {
                    const existing = this.sources.find(s => s.id === stored.id);
                    if (existing) {
                        existing.enabled = stored.enabled;
                    } else {
                        this.sources.push({
                            ...stored,
                            movies: [],
                            status: 'pending',
                            lastUpdate: null
                        });
                    }
                });
            }
        } catch (error) {
            console.error('Error loading sources from storage:', error);
        }
    }
    
    getCachedSource(sourceId) {
        if (!this.cacheEnabled) return null;
        
        try {
            const cached = localStorage.getItem(`cache_${sourceId}`);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            
            if (Date.now() - timestamp > this.cacheExpiry) {
                localStorage.removeItem(`cache_${sourceId}`);
                return null;
            }
            
            return data;
        } catch (error) {
            return null;
        }
    }
    
    setCachedSource(sourceId, data) {
        try {
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(`cache_${sourceId}`, JSON.stringify(cacheData));
        } catch (error) {
            console.error('Error caching source:', error);
        }
    }
    
    // Utilities
    handleKeyboard(e) {
        if (this.movieOverlay.style.display === 'block') {
            if (e.key === 'Escape') {
                this.closeModal();
            }
        }
        
        if (this.settingsModal.style.display === 'block') {
            if (e.key === 'Escape') {
                this.settingsModal.style.display = 'none';
            }
        }
    }
    
    chunkArray(array, size) {
        const chunks = [];
        for (let i = 0; i < array.length; i += size) {
            chunks.push(array.slice(i, i + size));
        }
        return chunks;
    }
    
    getRandomColor() {
        const colors = ['#e50914', '#46d369', '#ffa500', '#00a8e1', '#ff69b4', '#9b59b6'];
        return colors[Math.floor(Math.random() * colors.length)];
    }
    
    getPlaceholderImage(title) {
        return `https://via.placeholder.com/300x450/2a2a2a/e50914?text=${encodeURIComponent(title.substring(0, 20))}`;
    }
    
    setLoadingState(loading) {
        this.isLoading = loading;
        this.loader.classList.toggle('hidden', !loading);
    }
    
    updateStatus(status, text) {
        const classes = {
            'connected': 'connected',
            'loading': 'loading',
            'error': 'error',
            'partial': 'connected'
        };
        
        this.statusIndicator.className = `status-indicator ${classes[status] || ''}`;
        this.statusText.textContent = text;
    }
    
    updateMovieCount(count) {
        this.movieCount.textContent = `${count.toLocaleString()} películas`;
    }
    
    showError(message) {
        this.errorMessage.textContent = message;
        this.errorMessage.classList.add('show');
        setTimeout(() => {
            this.errorMessage.classList.remove('show');
        }, 3000);
    }
}

// Initialize when DOM is ready
let platform = null;

document.addEventListener('DOMContentLoaded', () => {
    platform = new MultiSourceMoviesPlatform();
    
    // Handle browser back button
    window.addEventListener('popstate', (event) => {
        if (platform && platform.movieOverlay.style.display === 'block') {
            platform.closeModal();
        }
    });
});
</script>

</body>
</html>
