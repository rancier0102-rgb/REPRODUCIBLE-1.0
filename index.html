<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IPTV Player TV</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
  background: #141414;
  color: #fff;
  overflow-x: hidden;
}
a { color: inherit; text-decoration: none; }

.header {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 10px 30px 5px 30px;
  background: #181818;
  box-shadow: 0 2px 12px #0005;
  position: sticky;
  top: 0;
  z-index: 10;
  min-height: 48px;
}
.search-bar {
  background: #232323;
  border-radius: 30px;
  padding: 7px 18px;
  display: flex;
  align-items: center;
  box-shadow: 0 2px 8px #0002;
  transition: box-shadow 0.2s, border 0.2s;
}
.search-bar.focused {
  box-shadow: 0 0 0 3px #1e90ff, 0 2px 8px #1e90ff55;
  border: 2px solid #1e90ff;
}
.search-bar input {
  background: transparent;
  border: none;
  outline: none;
  color: #fff;
  font-size: 1.2em;
  width: 320px;
  margin-left: 8px;
}
.search-bar input::placeholder { color: #bbb; }

.main { padding: 18px 30px; box-sizing: border-box; }
.section { margin-bottom: 36px; transition: transform 0.4s ease, opacity 0.4s ease; }
.section.active { transform: scale(1.03); opacity: 1; }
.section h2 { font-size: 1.3em; margin-bottom: 16px; color: #fff; letter-spacing: 1px; }
.row {
  display: flex;
  overflow-x: auto;
  gap: 16px; /* Menor separación entre posters */
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 8px;
  align-items: flex-end;
  min-height: 470px;
}
.row::-webkit-scrollbar { display: none; }
.channel {
  flex: 0 0 300px; /* 2:3 ratio width */
  cursor: pointer;
  border-radius: 0;
  font-size: 1.2em;
  background: #232323;
  box-shadow: 0 12px 40px rgba(0,0,0,0.8);
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
  overflow: hidden;
  min-height: 450px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 4px solid transparent;
  padding-bottom: 0;
}
.channel img {
  width: 100%;
  aspect-ratio: 2/3;
  height: 450px; /* 2:3 ratio for 300px width */
  object-fit: cover;
  background: #181818;
  border-radius: 0;
  box-shadow: 0 2px 16px #000a;
  display: block;
}
.channel p { display: none; }
.channel.focused {
  border: 4px solid #1e90ff;
  box-shadow: 0 0 60px #1e90ffcc, 0 12px 40px rgba(0,0,0,0.8);
  transform: scale(1.15);
  z-index: 2;
}
@media (max-width: 1200px) {
  .main { padding: 10px 5px; }
  .header { padding: 10px 10px 5px 10px; }
  .section h2 { font-size: 1.1em; }
  .channel { flex: 0 0 160px; min-height: 240px; }
  .channel img { height: 240px; }
  .row { min-height: 240px; gap: 8px; }
}
@media (max-width: 700px) {
  .channel { flex: 0 0 90px; min-height: 120px; }
  .channel img { height: 135px; }
  .row { min-height: 120px; gap: 4px; }
}

/* Tooltip */
#tooltip {
  display: none;
  position: fixed;
  z-index: 1000;
  background: #232323e0;
  color: #fff;
  padding: 12px 22px;
  border-radius: 10px;
  box-shadow: 0 4px 24px #000a;
  font-size: 1.1em;
  pointer-events: none;
  max-width: 340px;
  min-width: 120px;
  transition: opacity 0.2s;
  opacity: 0;
  white-space: pre-line;
}
#tooltip.visible {
  display: block;
  opacity: 1;
}
</style>
</head>

<body>
<div class="header">
  <div class="search-bar" id="searchBar">
    <svg width="20" height="20" fill="#bbb" viewBox="0 0 20 20"><circle cx="9" cy="9" r="7" stroke="#bbb" stroke-width="2" fill="none"/><line x1="15" y1="15" x2="19" y2="19" stroke="#bbb" stroke-width="2" stroke-linecap="round"/></svg>
    <input id="searchInput" type="text" placeholder="Buscar canal o película..." autocomplete="off" />
  </div>
</div>

<div class="main" id="mainContent"></div>
<div id="tooltip"></div>

<script>
const PLAYLIST_URL_MOVIES = "https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/peliculas.html";
let moviesByCategory = {};
let allChannels = [];
let lastPlayed = []; // Para "Seguir Viendo"

// --- PARSEADOR M3U ---
function parseM3U(text) {
  const lines = text.split("\n");
  const channels = [];
  let current = {};
  for (let line of lines) {
    line = line.trim();
    if (line.startsWith("#EXTINF:")) {
      const logo = line.match(/tvg-logo="([^"]*)"/);
      const name = line.split(",").pop();
      const cat = line.match(/group-title="([^"]*)"/);
      current.logo = logo ? logo[1] : "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";
      current.name = name;
      current.category = cat ? cat[1] : "Sin categoría";
    } else if (line && !line.startsWith("#")) {
      current.url = line;
      channels.push({...current});
      current = {};
    }
  }
  return channels;
}

// --- CARGA DE LISTA ---
async function loadPlaylist() {
  try {
    const res = await fetch(PLAYLIST_URL_MOVIES);
    const text = await res.text();
    const channels = parseM3U(text);
    allChannels = channels;
    organizeByCategory(channels);
    loadLastPlayed();
    renderAllCategories();
    initTVNavigation();
  } catch (e) { console.error(e); }
}

function organizeByCategory(channels) {
  moviesByCategory = {};
  channels.forEach(ch => {
    if (!moviesByCategory[ch.category]) moviesByCategory[ch.category] = [];
    moviesByCategory[ch.category].push(ch);
  });
}

function renderAllCategories(filtered = null) {
  const main = document.getElementById("mainContent");
  main.innerHTML = "";

  // --- SEGUIR VIENDO ---
  if (lastPlayed.length > 0) {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h2>Seguir Viendo</h2><div class="row" id="row_SeguirViendo"></div>`;
    main.appendChild(section);
    renderChannels(lastPlayed, "row_SeguirViendo", true);
  }

  // --- CATEGORÍAS ---
  const cats = filtered ? Object.keys(filtered) : Object.keys(moviesByCategory);
  cats.forEach(cat => {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h2>${cat}</h2><div class="row" id="row_${cat.replace(/\s+/g,'_')}"></div>`;
    main.appendChild(section);
    renderChannels(filtered ? filtered[cat] : moviesByCategory[cat], `row_${cat.replace(/\s+/g,'_')}`);
  });
}

function renderChannels(channels, rowId, isLastPlayed = false) {
  const row = document.getElementById(rowId);
  row.innerHTML = "";
  channels.forEach((ch, idx) => {
    const div = document.createElement("div");
    div.className = "channel";
    div.innerHTML = `<img src="${ch.logo}" alt="${ch.name}">`;
    div.onclick = () => playChannel(ch, isLastPlayed);

    // Tooltip al mouse
    div.onmouseenter = (e) => showTooltip(ch, e);
    div.onmousemove = (e) => moveTooltip(e);
    div.onmouseleave = hideTooltip;

    // Guardar datos para tooltip en navegación por control
    div.dataset.name = ch.name;
    div.dataset.category = ch.category;
    row.appendChild(div);
  });
}

// --- TOOLTIP ---
function showTooltip(ch, e) {
  const tooltip = document.getElementById("tooltip");
  tooltip.innerHTML = `<b>${ch.name}</b><br><small>${ch.category}</small>`;
  tooltip.classList.add("visible");
  if (e && e.clientX && e.clientY) {
    tooltip.style.top = (e.clientY + 20) + "px";
    tooltip.style.left = (e.clientX + 20) + "px";
  }
}
function moveTooltip(e) {
  const tooltip = document.getElementById("tooltip");
  if (e && e.clientX && e.clientY) {
    tooltip.style.top = (e.clientY + 20) + "px";
    tooltip.style.left = (e.clientX + 20) + "px";
  }
}
function hideTooltip() {
  const tooltip = document.getElementById("tooltip");
  tooltip.classList.remove("visible");
}

// --- SEGUIR VIENDO ---
function playChannel(ch, isLastPlayed = false) {
  // Guardar en "Seguir Viendo"
  if (!isLastPlayed) {
    lastPlayed = lastPlayed.filter(item => item.url !== ch.url);
    lastPlayed.unshift(ch);
    if (lastPlayed.length > 12) lastPlayed = lastPlayed.slice(0, 12);
    localStorage.setItem("iptv_lastPlayed", JSON.stringify(lastPlayed));
    renderAllCategories();
    initTVNavigation();
  }
  window.open(ch.url, "_blank");
}
function loadLastPlayed() {
  try {
    const data = JSON.parse(localStorage.getItem("iptv_lastPlayed") || "[]");
    lastPlayed = data.filter(lp => allChannels.find(ch => ch.url === lp.url));
  } catch { lastPlayed = []; }
}

// --- BARRA DE BÚSQUEDA ---
document.getElementById("searchInput").addEventListener("input", function() {
  const q = this.value.trim().toLowerCase();
  if (!q) {
    renderAllCategories();
    initTVNavigation();
    return;
  }
  // Filtrar canales
  const filtered = {};
  allChannels.forEach(ch => {
    if (
      ch.name.toLowerCase().includes(q) ||
      ch.category.toLowerCase().includes(q)
    ) {
      if (!filtered[ch.category]) filtered[ch.category] = [];
      filtered[ch.category].push(ch);
    }
  });
  renderAllCategories(filtered);
  initTVNavigation();
});

// --- NAVEGACIÓN CON CONTROL REMOTO / TECLADO Y BARRA DE BÚSQUEDA ---
let focusedRow = 0;
let focusedCol = 0;
let sectionElements = [];
let searchFocused = false;
let lastTooltipIndex = {row: 0, col: 0};

function initTVNavigation() {
  sectionElements = Array.from(document.querySelectorAll(".section .row"));
  if (!searchFocused) {
    focusedRow = 0;
    focusedCol = 0;
  }
  updateFocus();
}

function updateFocus() {
  document.querySelectorAll(".focused").forEach(el => el.classList.remove("focused"));
  document.getElementById("searchBar").classList.remove("focused");
  hideTooltip();

  if (searchFocused) {
    document.getElementById("searchInput").focus();
    document.getElementById("searchBar").classList.add("focused");
    return;
  }

  if (focusedRow < 0) focusedRow = 0;
  if (focusedRow >= sectionElements.length) focusedRow = sectionElements.length - 1;

  const row = sectionElements[focusedRow];
  if (!row) return;
  const channels = row.querySelectorAll(".channel");
  if (channels.length === 0) return;
  if (focusedCol < 0) focusedCol = 0;
  if (focusedCol >= channels.length) focusedCol = channels.length - 1;
  const channel = channels[focusedCol];
  if (!channel) return;
  channel.classList.add("focused");
  channel.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
  row.parentElement.classList.add("active");

  // Tooltip al enfocar con control/teclado
  showTooltipFromChannel(channel);
}

function showTooltipFromChannel(channel) {
  if (!channel) return;
  const name = channel.dataset.name || "";
  const category = channel.dataset.category || "";
  const tooltip = document.getElementById("tooltip");
  tooltip.innerHTML = `<b>${name}</b><br><small>${category}</small>`;
  tooltip.classList.add("visible");

  // Posiciona el tooltip cerca del póster enfocado
  const rect = channel.getBoundingClientRect();
  let top = rect.top + window.scrollY + 30;
  let left = rect.left + window.scrollX + rect.width + 20;
  // Si se sale de la pantalla, ajusta
  if (left + 340 > window.innerWidth) left = window.innerWidth - 360;
  if (top + 80 > window.innerHeight) top = window.innerHeight - 100;
  tooltip.style.top = top + "px";
  tooltip.style.left = left + "px";
}

document.addEventListener("keydown", e => {
  let handled = true;

  if (searchFocused) {
    if (e.key === "ArrowDown") {
      searchFocused = false;
      focusedRow = 0;
      focusedCol = 0;
      updateFocus();
      e.preventDefault();
      return;
    }
    // Permite escribir normalmente en la barra de búsqueda
    return;
  }

  switch (e.key) {
    case "ArrowRight": focusedCol++; break;
    case "ArrowLeft": focusedCol--; break;
    case "ArrowDown": focusedRow++; break;
    case "ArrowUp":
      if (focusedRow === 0) {
        searchFocused = true;
        updateFocus();
        e.preventDefault();
        return;
      } else {
        focusedRow--;
      }
      break;
    case "Enter":
    case "OK":
      const row = sectionElements[focusedRow];
      const item = row?.querySelectorAll(".channel")[focusedCol];
      if (item) item.click();
      break;
    default: handled = false;
  }

  if (!handled) return;

  if (focusedRow < 0) focusedRow = 0;
  if (focusedRow >= sectionElements.length) focusedRow = sectionElements.length - 1;

  const currentRow = sectionElements[focusedRow];
  if (focusedRow >= 0 && currentRow) {
    const totalCols = currentRow.querySelectorAll(".channel").length;
    if (focusedCol < 0) focusedCol = 0;
    if (focusedCol >= totalCols) focusedCol = totalCols - 1;
  }
  updateFocus();
  e.preventDefault();
});

// Permite salir de la barra de búsqueda con ESC
document.getElementById("searchInput").addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    searchFocused = false;
    updateFocus();
    e.preventDefault();
  }
});

document.addEventListener("DOMContentLoaded", loadPlaylist);
</script>
</body>
</html>
