<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a0a10">
    <title>ReelDrama</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
        :root{
            --primary:#ff4d88;
            --primary-dark:#cc3d6d;
            --primary-light:#ff79a8;
            --primary-glow:rgba(255,77,136,0.3);
            --accent:#ff1a5c;
            --bg:#0d0609;
            --bg-gradient:linear-gradient(180deg, #1a0a10 0%, #0d0609 100%);
            --surface:#1a0d12;
            --surface-light:#2a1520;
            --surface-hover:#3a1f2d;
            --text:#fff;
            --text2:#b89aa8;
            --text3:#7a5a68;
            --border:#3d1f2a;
            --border-light:#5a3040;
            --success:#4ade80;
            --card-gradient:linear-gradient(145deg, rgba(255,77,136,0.1) 0%, transparent 50%);
            --safe-top:env(safe-area-inset-top);
            --safe-bottom:env(safe-area-inset-bottom);
            --safe-left:env(safe-area-inset-left);
            --safe-right:env(safe-area-inset-right)
        }
        
        html,body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg);
            background-image:var(--bg-gradient);
            color:var(--text);
            min-height:100vh;
            min-height:100dvh;
            overflow-x:hidden;
            -webkit-font-smoothing:antialiased
        }
        
        #app{
            min-height:100vh;
            min-height:100dvh;
            display:flex;
            flex-direction:column
        }
        
        .header{
            padding:10px 12px;
            padding-top:calc(10px + var(--safe-top));
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            background:linear-gradient(180deg, rgba(26,10,16,0.98) 0%, rgba(26,10,16,0.95) 100%);
            backdrop-filter:blur(20px);
            -webkit-backdrop-filter:blur(20px);
            border-bottom:1px solid var(--border);
            display:flex;
            align-items:center;
            gap:8px;
            position:sticky;
            top:0;
            z-index:100;
            flex-shrink:0
        }
        
        .logo{
            font-size:16px;
            font-weight:800;
            background:linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            white-space:nowrap;
            flex-shrink:0
        }
        
        #search{
            flex:1;
            min-width:0;
            padding:8px 14px;
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:20px;
            color:var(--text);
            font-size:14px;
            outline:none;
            transition:all 0.3s ease
        }
        
        #search::placeholder{color:var(--text3)}
        #search:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 2px var(--primary-glow)
        }
        
        .header-stats{
            font-size:10px;
            color:var(--text2);
            text-align:right;
            white-space:nowrap;
            flex-shrink:0;
            display:none
        }
        
        @media(min-width:360px){
            .header-stats{display:block}
        }
        
        .header-stats strong{
            color:var(--primary-light);
            font-weight:600
        }
        
        .btn-icon{
            background:var(--surface);
            border:1px solid var(--border);
            color:var(--primary-light);
            width:36px;
            height:36px;
            min-width:36px;
            border-radius:50%;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:14px;
            transition:all 0.2s ease;
            flex-shrink:0
        }
        
        .btn-icon:active{
            transform:scale(0.92);
            background:var(--surface-light)
        }
        
        .pull-indicator{
            text-align:center;
            padding:12px;
            color:var(--text2);
            font-size:12px;
            display:none;
            background:linear-gradient(180deg, var(--surface) 0%, transparent 100%)
        }
        
        .pull-indicator.visible{display:block}
        
        .pull-indicator.loading::after{
            content:'';
            display:inline-block;
            width:14px;
            height:14px;
            margin-left:8px;
            border:2px solid var(--border);
            border-top-color:var(--primary);
            border-radius:50%;
            animation:spin .8s linear infinite;
            vertical-align:middle
        }
        
        .content{
            flex:1;
            padding:8px;
            padding-left:calc(8px + var(--safe-left));
            padding-right:calc(8px + var(--safe-right));
            padding-bottom:calc(8px + var(--safe-bottom));
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch
        }
        
        .section-title{
            font-size:14px;
            font-weight:700;
            margin-bottom:12px;
            padding-left:4px;
            display:flex;
            align-items:center;
            gap:8px
        }
        
        .section-title::before{
            content:'';
            width:3px;
            height:16px;
            background:linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius:2px;
            flex-shrink:0
        }
        
        .grid{
            display:grid;
            grid-template-columns:repeat(3, 1fr);
            gap:6px
        }
        
        @media(min-width:360px){
            .grid{gap:8px}
        }
        
        @media(min-width:480px){
            .grid{
                grid-template-columns:repeat(4, 1fr);
                gap:10px
            }
        }
        
        @media(min-width:600px){
            .grid{
                grid-template-columns:repeat(5, 1fr);
                gap:12px
            }
        }
        
        @media(min-width:768px){
            .grid{
                grid-template-columns:repeat(6, 1fr);
                gap:14px
            }
        }
        
        @media(min-width:1024px){
            .grid{
                grid-template-columns:repeat(7, 1fr);
                gap:16px
            }
        }
        
        @media(min-width:1280px){
            .grid{grid-template-columns:repeat(8, 1fr)}
        }
        
        .card{
            aspect-ratio:2/3;
            border-radius:8px;
            overflow:hidden;
            cursor:pointer;
            position:relative;
            background:var(--surface);
            border:1px solid var(--border);
            transition:transform 0.2s ease, box-shadow 0.2s ease
        }
        
        .card:active{
            transform:scale(0.96)
        }
        
        @media(hover:hover){
            .card:hover{
                transform:translateY(-4px);
                border-color:var(--primary);
                box-shadow:0 8px 25px rgba(255,77,136,0.2)
            }
        }
        
        .card-poster{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
            background:var(--surface-light);
            opacity:0;
            transition:opacity 0.3s ease
        }
        
        .card-poster.loaded{opacity:1}
        .card-poster.error{opacity:0.3}
        
        .card-overlay{
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            padding:20px 6px 6px;
            background:linear-gradient(transparent, rgba(13,6,9,0.95));
            pointer-events:none
        }
        
        .card-overlay-title{
            font-size:9px;
            font-weight:600;
            line-height:1.2;
            color:#fff;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
            word-break:break-word
        }
        
        @media(min-width:360px){
            .card-overlay-title{font-size:10px}
        }
        
        .card-badge{
            position:absolute;
            top:4px;
            right:4px;
            background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color:#fff;
            font-size:8px;
            padding:2px 5px;
            border-radius:8px;
            font-weight:700
        }
        
        @media(min-width:360px){
            .card-badge{
                font-size:9px;
                padding:3px 6px
            }
        }
        
        .detail,.player{
            position:fixed;
            inset:0;
            background:var(--bg);
            z-index:1000;
            display:none;
            flex-direction:column
        }
        
        .player{z-index:2000;background:#000}
        .detail.active,.player.active{display:flex}
        
        .detail-header{
            padding:10px 12px;
            padding-top:calc(10px + var(--safe-top));
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            display:flex;
            align-items:center;
            gap:10px;
            background:var(--surface);
            border-bottom:1px solid var(--border);
            flex-shrink:0
        }
        
        .player-header{
            background:linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            position:absolute;
            top:0;
            left:0;
            right:0;
            z-index:10;
            border:none;
            padding:10px 12px;
            padding-top:calc(10px + var(--safe-top));
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            display:flex;
            align-items:center;
            gap:10px
        }
        
        .detail-title,.player-title{
            flex:1;
            min-width:0;
            font-size:15px;
            font-weight:700;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap
        }
        
        .player-title{font-size:13px;color:#fff}
        
        .btn-back{
            background:var(--surface-light);
            border:1px solid var(--border);
            color:var(--primary-light);
            width:36px;
            height:36px;
            min-width:36px;
            border-radius:50%;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:18px;
            transition:all 0.2s ease;
            flex-shrink:0
        }
        
        .btn-back:active{
            transform:scale(0.9);
            background:var(--surface-hover)
        }
        
        .detail-hero{
            position:relative;
            min-height:140px;
            max-height:180px;
            background:var(--surface);
            overflow:hidden;
            flex-shrink:0
        }
        
        @media(min-width:480px){
            .detail-hero{
                min-height:160px;
                max-height:200px
            }
        }
        
        .detail-hero-bg{
            position:absolute;
            inset:0;
            background-size:cover;
            background-position:center top;
            filter:blur(15px);
            opacity:0.5;
            transform:scale(1.1)
        }
        
        .detail-hero-overlay{
            position:absolute;
            inset:0;
            background:linear-gradient(180deg, transparent 0%, var(--bg) 100%)
        }
        
        .detail-hero-content{
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            padding:12px;
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            display:flex;
            gap:12px;
            align-items:flex-end
        }
        
        .detail-poster{
            width:70px;
            height:105px;
            border-radius:6px;
            object-fit:cover;
            border:2px solid var(--primary);
            box-shadow:0 4px 15px rgba(0,0,0,0.5);
            flex-shrink:0;
            background:var(--surface-light)
        }
        
        @media(min-width:480px){
            .detail-poster{
                width:85px;
                height:127px
            }
        }
        
        .detail-info{
            flex:1;
            min-width:0;
            padding-bottom:4px
        }
        
        .detail-info h2{
            font-size:16px;
            font-weight:700;
            margin-bottom:4px;
            line-height:1.2;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden
        }
        
        @media(min-width:480px){
            .detail-info h2{font-size:18px}
        }
        
        .detail-meta{
            font-size:11px;
            color:var(--text2);
            display:flex;
            gap:10px;
            flex-wrap:wrap
        }
        
        .detail-meta span{
            display:flex;
            align-items:center;
            gap:4px;
            white-space:nowrap
        }
        
        .seasons{
            padding:10px 12px;
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            display:flex;
            gap:8px;
            overflow-x:auto;
            background:var(--surface);
            border-bottom:1px solid var(--border);
            -webkit-overflow-scrolling:touch;
            flex-shrink:0;
            scrollbar-width:none;
            -ms-overflow-style:none
        }
        
        .seasons::-webkit-scrollbar{display:none}
        
        .season-btn{
            padding:8px 14px;
            background:var(--bg);
            border:1px solid var(--border);
            border-radius:20px;
            color:var(--text2);
            cursor:pointer;
            white-space:nowrap;
            font-size:12px;
            font-weight:600;
            transition:all 0.2s ease;
            flex-shrink:0
        }
        
        .season-btn:active{
            transform:scale(0.95)
        }
        
        .season-btn.active{
            background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color:transparent;
            color:#fff
        }
        
        .episodes{
            flex:1;
            overflow-y:auto;
            overflow-x:hidden;
            padding:12px;
            padding-left:calc(12px + var(--safe-left));
            padding-right:calc(12px + var(--safe-right));
            padding-bottom:calc(12px + var(--safe-bottom));
            -webkit-overflow-scrolling:touch
        }
        
        .episode{
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:10px;
            padding:12px;
            margin-bottom:8px;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:12px;
            transition:all 0.2s ease
        }
        
        .episode:active{
            transform:scale(0.98);
            background:var(--surface-light)
        }
        
        .episode:last-child{margin-bottom:0}
        
        .episode-number{
            background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color:#fff;
            min-width:32px;
            width:32px;
            height:32px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:11px;
            font-weight:700;
            flex-shrink:0
        }
        
        .episode-info{
            flex:1;
            min-width:0
        }
        
        .episode-title{
            font-size:13px;
            font-weight:600;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            margin-bottom:2px
        }
        
        .episode-meta{
            font-size:10px;
            color:var(--text3)
        }
        
        .episode-play{
            color:var(--primary);
            font-size:16px;
            flex-shrink:0;
            opacity:0.6
        }
        
        .video-container{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            background:#000
        }
        
        video{
            width:100%;
            height:100%;
            max-height:100vh;
            max-height:100dvh
        }
        
        .loading,.empty,.error{
            text-align:center;
            padding:40px 16px;
            color:var(--text2);
            font-size:13px;
            grid-column:1/-1
        }
        
        .loading::after{
            content:'';
            display:block;
            width:24px;
            height:24px;
            margin:16px auto 0;
            border:2px solid var(--border);
            border-top-color:var(--primary);
            border-radius:50%;
            animation:spin .8s linear infinite
        }
        
        .empty-icon{
            font-size:32px;
            margin-bottom:12px;
            opacity:0.4;
            color:var(--primary)
        }
        
        .retry-btn{
            margin-top:16px;
            padding:10px 24px;
            background:var(--primary);
            border:none;
            border-radius:20px;
            color:#fff;
            font-size:13px;
            font-weight:600;
            cursor:pointer
        }
        
        .retry-btn:active{opacity:0.8}
        
        @keyframes spin{to{transform:rotate(360deg)}}
        
        ::-webkit-scrollbar{width:3px;height:3px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        
        @keyframes fadeIn{
            from{opacity:0;transform:scale(0.95)}
            to{opacity:1;transform:scale(1)}
        }
        
        .card{
            opacity:0;
            animation:fadeIn 0.3s ease forwards
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="logo">ReelDrama</div>
            <input type="search" id="search" placeholder="Buscar series...">
            <div class="header-stats" id="stats"><strong>0</strong> series</div>
            <button class="btn-icon" id="btn-reload" title="Recargar datos">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
            </button>
        </div>
        
        <div class="pull-indicator" id="pull-indicator">Suelta para mezclar</div>
        
        <div class="content" id="content">
            <div class="section-title">Series Populares</div>
            <div class="grid" id="grid">
                <div class="loading">Cargando series...</div>
            </div>
        </div>
        
        <div class="detail" id="detail">
            <div class="detail-header">
                <button class="btn-back" id="detail-back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="detail-title" id="detail-title"></div>
            </div>
            <div class="detail-hero" id="detail-hero">
                <div class="detail-hero-bg" id="detail-hero-bg"></div>
                <div class="detail-hero-overlay"></div>
                <div class="detail-hero-content">
                    <img class="detail-poster" id="detail-poster" src="" alt="">
                    <div class="detail-info">
                        <h2 id="detail-name"></h2>
                        <div class="detail-meta" id="detail-meta"></div>
                    </div>
                </div>
            </div>
            <div class="seasons" id="seasons"></div>
            <div class="episodes" id="episodes"></div>
        </div>
        
        <div class="player" id="player">
            <div class="player-header">
                <button class="btn-back" id="player-back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="player-title" id="player-title"></div>
            </div>
            <div class="video-container">
                <video id="video" controls playsinline></video>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        // ===== CONFIGURACIÓN =====
        const CONFIG = {
            DATA_FILE: 'data.json',
            CACHE_KEY: 'reeldrama_data',
            CACHE_TIME_KEY: 'reeldrama_cache_time',
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutos
            ITEMS_PER_PAGE: 50
        };
        
        const state = {
            rawData: [],
            seriesList: [],
            seriesIndex: {},
            totalEpisodes: 0,
            page: 0,
            hasMore: true,
            loading: false,
            search: '',
            currentSeries: null,
            currentSeason: null,
            currentView: 'home'
        };
        
        let el = {};
        
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            el = {
                grid: document.getElementById('grid'),
                content: document.getElementById('content'),
                search: document.getElementById('search'),
                stats: document.getElementById('stats'),
                pullIndicator: document.getElementById('pull-indicator'),
                detail: document.getElementById('detail'),
                detailBack: document.getElementById('detail-back'),
                detailTitle: document.getElementById('detail-title'),
                detailHeroBg: document.getElementById('detail-hero-bg'),
                detailPoster: document.getElementById('detail-poster'),
                detailName: document.getElementById('detail-name'),
                detailMeta: document.getElementById('detail-meta'),
                seasons: document.getElementById('seasons'),
                episodes: document.getElementById('episodes'),
                player: document.getElementById('player'),
                playerBack: document.getElementById('player-back'),
                playerTitle: document.getElementById('player-title'),
                video: document.getElementById('video'),
                btnReload: document.getElementById('btn-reload')
            };
            
            setupEvents();
            setupPullRefresh();
            setupBackButton();
            
            // Cargar datos automáticamente
            loadDataFromFile();
        }
        
        // ===== CARGA DE DATOS =====
        async function loadDataFromFile(forceReload = false) {
            // Intentar usar caché primero
            if (!forceReload) {
                const cached = loadFromCache();
                if (cached) {
                    processData(cached);
                    return;
                }
            }
            
            showLoading();
            
            try {
                // Añadir timestamp para evitar caché del navegador
                const url = CONFIG.DATA_FILE + '?t=' + Date.now();
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('No se pudo cargar el archivo');
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('El archivo está vacío o no es válido');
                }
                
                // Guardar en caché
                saveToCache(data);
                
                processData(data);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError(error.message);
            }
        }
        
        function showLoading() {
            el.grid.innerHTML = '<div class="loading">Cargando series...</div>';
        }
        
        function showError(message) {
            el.grid.innerHTML = 
                '<div class="error">' +
                    '<div class="empty-icon">' +
                        '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
                            '<circle cx="12" cy="12" r="10"/>' +
                            '<line x1="12" y1="8" x2="12" y2="12"/>' +
                            '<line x1="12" y1="16" x2="12.01" y2="16"/>' +
                        '</svg>' +
                    '</div>' +
                    '<div>' + esc(message) + '</div>' +
                    '<button class="retry-btn" onclick="location.reload()">Reintentar</button>' +
                '</div>';
        }
        
        // ===== CACHÉ =====
        function saveToCache(data) {
            try {
                localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CONFIG.CACHE_TIME_KEY, Date.now().toString());
            } catch(e) {
                console.warn('No se pudo guardar en caché:', e);
            }
        }
        
        function loadFromCache() {
            try {
                const cacheTime = localStorage.getItem(CONFIG.CACHE_TIME_KEY);
                if (!cacheTime) return null;
                
                // Verificar si el caché expiró
                if (Date.now() - parseInt(cacheTime) > CONFIG.CACHE_DURATION) {
                    return null;
                }
                
                const cached = localStorage.getItem(CONFIG.CACHE_KEY);
                if (!cached) return null;
                
                const data = JSON.parse(cached);
                if (Array.isArray(data) && data.length > 0) {
                    return data;
                }
            } catch(e) {
                console.warn('Error leyendo caché:', e);
            }
            return null;
        }
        
        function clearCache() {
            try {
                localStorage.removeItem(CONFIG.CACHE_KEY);
                localStorage.removeItem(CONFIG.CACHE_TIME_KEY);
            } catch(e) {}
        }
        
        // ===== PROCESAMIENTO =====
        function processData(data) {
            state.rawData = data;
            state.totalEpisodes = data.length;
            
            const map = {};
            
            data.forEach(item => {
                const name = item.series || item.name || 'Sin nombre';
                const season = String(item.season || '1');
                
                if (!map[name]) {
                    map[name] = {
                        name,
                        poster: item["logo serie"] || item.poster || '',
                        seasons: {},
                        count: 0
                    };
                }
                
                if (!map[name].seasons[season]) map[name].seasons[season] = [];
                
                map[name].seasons[season].push({
                    ep: item.ep || item.episode || 1,
                    title: item.title || 'Episodio ' + (item.ep || 1),
                    url: item.url || '',
                    thumbnail: item["logo ep"] || ''
                });
                
                map[name].count++;
            });
            
            Object.values(map).forEach(series => {
                Object.keys(series.seasons).forEach(season => {
                    series.seasons[season].sort((a, b) => a.ep - b.ep);
                });
            });
            
            state.seriesIndex = map;
            state.seriesList = Object.values(map)
                .map(s => ({ name: s.name, poster: s.poster, seasons: Object.keys(s.seasons).length, count: s.count }))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            updateStats();
            loadSeries(false, true);
        }
        
        function updateStats() {
            el.stats.innerHTML = '<strong>' + state.seriesList.length + '</strong> series';
        }
        
        // ===== RENDERIZADO =====
        function loadSeries(append, random) {
            if (state.loading || (append && !state.hasMore)) return;
            
            state.loading = true;
            
            if (!append) {
                el.grid.innerHTML = '<div class="loading">Cargando...</div>';
                state.page = 0;
                state.hasMore = true;
            }
            
            let list = [...state.seriesList];
            
            if (state.search) {
                const q = state.search.toLowerCase();
                list = list.filter(s => s.name.toLowerCase().includes(q));
            }
            
            if (random && !state.search) {
                for (let i = list.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [list[i], list[j]] = [list[j], list[i]];
                }
            }
            
            const total = list.length;
            const start = state.page * CONFIG.ITEMS_PER_PAGE;
            const end = start + CONFIG.ITEMS_PER_PAGE;
            const pageData = list.slice(start, end);
            
            requestAnimationFrame(() => {
                if (!append) el.grid.innerHTML = '';
                
                if (!pageData.length && !append) {
                    el.grid.innerHTML = 
                        '<div class="empty">' +
                            '<div class="empty-icon">' +
                                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
                                    '<circle cx="11" cy="11" r="8"/>' +
                                    '<path d="M21 21l-4.35-4.35"/>' +
                                '</svg>' +
                            '</div>' +
                            '<div>Sin resultados</div>' +
                        '</div>';
                    state.loading = false;
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                pageData.forEach((s, i) => {
                    const card = createCard(s, start + i);
                    fragment.appendChild(card);
                });
                el.grid.appendChild(fragment);
                
                state.page++;
                state.hasMore = end < total;
                state.loading = false;
            });
        }
        
        function createCard(s, index) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = (index % 12) * 0.03 + 's';
            
            card.innerHTML = 
                '<img class="card-poster" data-src="' + esc(s.poster) + '" alt="">' +
                '<div class="card-badge">' + s.count + '</div>' +
                '<div class="card-overlay"><div class="card-overlay-title">' + esc(s.name) + '</div></div>';
            
            imageObserver.observe(card.querySelector('.card-poster'));
            card.addEventListener('click', () => openDetail(s.name));
            
            return card;
        }
        
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    
                    if (src) {
                        img.src = src;
                        img.onload = () => img.classList.add('loaded');
                        img.onerror = () => {
                            img.classList.add('error');
                            img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 150"><rect fill="%231a0d12" width="100" height="150"/><rect x="35" y="55" width="30" height="40" rx="3" fill="%233d1f2a"/></svg>';
                        };
                    } else {
                        img.classList.add('error');
                    }
                    imageObserver.unobserve(img);
                }
            });
        }, { rootMargin: '150px' });
        
        // ===== DETALLE =====
        function openDetail(name) {
            const series = state.seriesIndex[name];
            if (!series) return;
            
            state.currentView = 'detail';
            state.currentSeries = series;
            history.pushState({ view: 'detail' }, '', '#detail');
            
            el.detailTitle.textContent = name;
            el.detailName.textContent = name;
            el.detailHeroBg.style.backgroundImage = 'url(' + series.poster + ')';
            el.detailPoster.src = series.poster || '';
            
            const seasonCount = Object.keys(series.seasons).length;
            el.detailMeta.innerHTML = '<span>' + seasonCount + ' temp.</span><span>' + series.count + ' eps.</span>';
            
            const keys = Object.keys(series.seasons).sort((a, b) => +a - +b);
            state.currentSeason = keys[0];
            
            renderSeasons(keys);
            renderEpisodes();
            
            el.detail.classList.add('active');
        }
        
        function renderSeasons(keys) {
            el.seasons.innerHTML = '';
            keys.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'season-btn' + (s === state.currentSeason ? ' active' : '');
                btn.textContent = 'T' + s;
                btn.addEventListener('click', () => {
                    state.currentSeason = s;
                    el.seasons.querySelectorAll('.season-btn').forEach(b => b.classList.toggle('active', b.textContent === 'T' + s));
                    renderEpisodes();
                });
                el.seasons.appendChild(btn);
            });
        }
        
        function renderEpisodes() {
            const eps = state.currentSeries?.seasons[state.currentSeason];
            
            if (!eps?.length) {
                el.episodes.innerHTML = '<div class="empty">Sin episodios</div>';
                return;
            }
            
            el.episodes.innerHTML = '';
            eps.forEach(ep => {
                const div = document.createElement('div');
                div.className = 'episode';
                div.innerHTML = 
                    '<div class="episode-number">' + ep.ep + '</div>' +
                    '<div class="episode-info"><div class="episode-title">' + esc(ep.title) + '</div>' +
                    '<div class="episode-meta">T' + state.currentSeason + ' E' + ep.ep + '</div></div>' +
                    '<div class="episode-play"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>';
                
                div.addEventListener('click', () => ep.url ? playVideo(ep) : alert('Sin URL'));
                el.episodes.appendChild(div);
            });
        }
        
        // ===== REPRODUCTOR =====
        function playVideo(ep) {
            state.currentView = 'player';
            history.pushState({ view: 'player' }, '', '#player');
            
            el.video.src = ep.url;
            el.playerTitle.textContent = ep.title;
            el.player.classList.add('active');
            el.video.play().catch(() => {});
        }
        
        function closeDetail() {
            el.detail.classList.remove('active');
            state.currentSeries = null;
            state.currentSeason = null;
            state.currentView = 'home';
        }
        
        function closePlayer() {
            el.video.pause();
            el.video.src = '';
            el.player.classList.remove('active');
            state.currentView = 'detail';
        }
        
        // ===== EVENTOS =====
        function setupEvents() {
            el.detailBack.addEventListener('click', closeDetail);
            el.playerBack.addEventListener('click', closePlayer);
            
            // Botón recargar
            el.btnReload.addEventListener('click', () => {
                clearCache();
                loadDataFromFile(true);
            });
            
            // Búsqueda
            let t;
            el.search.addEventListener('input', e => {
                clearTimeout(t);
                t = setTimeout(() => { 
                    state.search = e.target.value.trim(); 
                    loadSeries(false, !state.search); 
                }, 300);
            });
            
            // Scroll infinito
            el.content.addEventListener('scroll', () => {
                if (state.loading || !state.hasMore) return;
                const { scrollTop, scrollHeight, clientHeight } = el.content;
                if (scrollTop + clientHeight >= scrollHeight - 300) loadSeries(true, false);
            });
            
            document.addEventListener('keydown', e => { if (e.key === 'Escape') handleBack(); });
        }
        
        // ===== PULL TO REFRESH =====
        function setupPullRefresh() {
            let startY = 0, pulling = false;
            
            el.content.addEventListener('touchstart', e => {
                if (el.content.scrollTop === 0) { startY = e.touches[0].pageY; pulling = true; }
            }, { passive: true });
            
            el.content.addEventListener('touchmove', e => {
                if (!pulling) return;
                el.pullIndicator.classList.toggle('visible', e.touches[0].pageY - startY > 60);
            }, { passive: true });
            
            el.content.addEventListener('touchend', () => {
                if (el.pullIndicator.classList.contains('visible')) {
                    el.pullIndicator.textContent = 'Mezclando...';
                    el.pullIndicator.classList.add('loading');
                    setTimeout(() => {
                        loadSeries(false, true);
                        el.pullIndicator.classList.remove('visible', 'loading');
                        el.pullIndicator.textContent = 'Suelta para mezclar';
                    }, 400);
                }
                pulling = false;
            }, { passive: true });
        }
        
        // ===== NAVEGACIÓN =====
        function setupBackButton() { window.addEventListener('popstate', handleBack); }
        
        function handleBack() {
            if (state.currentView === 'player') closePlayer();
            else if (state.currentView === 'detail') closeDetail();
        }
        
        // ===== UTILIDADES =====
        function esc(s) { 
            return s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) : ''; 
        }
        
    })();
    </script>
</body>
</html>
