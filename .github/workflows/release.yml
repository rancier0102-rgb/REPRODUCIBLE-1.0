name: üöÄ Release FireTV App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
    
    # Setup Java
    - name: ‚òï Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    # Setup Gradle (sin gradlew)
    - name: üì¶ Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.0
    
    # Create local.properties
    - name: üìù Setup Android SDK
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        mkdir -p app/src/main/assets
    
    # Setup config files
    - name: üîß Setup Config Files
      run: |
        cat > app/src/main/assets/config.json << EOF
        {
          "cloudflare_token": "default",
          "discord_webhook": "default",
          "debug_mode": false
        }
        EOF
        
        cat > app/src/main/assets/movies.json << EOF
        {
          "chunkId": "movies_001",
          "items": []
        }
        EOF
        
        cat > app/src/main/assets/series.json << EOF
        {
          "chunkId": "series_001",
          "items": []
        }
        EOF
    
    # Build usando gradle directamente (sin wrapper)
    - name: üî® Build APK
      run: |
        gradle clean assembleDebug --no-daemon
        
        # Verificar que se cre√≥ el APK
        ls -la app/build/outputs/apk/debug/
    
    # Get version
    - name: üè∑Ô∏è Get Version
      id: version
      run: |
        VERSION="${GITHUB_REF_NAME:-v1.0.0}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    # Prepare files
    - name: üì¶ Prepare Release Files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Buscar APK
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp app/build/outputs/apk/debug/app-debug.apk "FireTV-Streaming-${VERSION}.apk"
          echo "‚úÖ APK ready"
        else
          echo "‚ùå APK not found"
          exit 1
        fi
    
    # Create Release
    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: FireTV Streaming ${{ steps.version.outputs.version }}
        body: |
          ## FireTV Streaming Release
          
          ### Installation
          ```bash
          adb install FireTV-Streaming-${{ steps.version.outputs.version }}.apk
          ```
        files: FireTV-Streaming-*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
