name: ðŸš€ Release FireTV App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (sin v, ej: 1.0.0)'
        required: false
        default: '1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    # Checkout
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Setup Java
    - name: â˜• Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    # Create local.properties
    - name: ðŸ“ Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "Local properties created"
    
    # Create assets directory
    - name: ðŸ“‚ Create Assets Directory
      run: |
        mkdir -p app/src/main/assets
        echo "Assets directory created"
    
    # Setup config files
    - name: ðŸ”§ Setup Config Files
      run: |
        # Config bÃ¡sico si no hay secrets
        if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
          echo '{"cloudflare_token":"default","discord_webhook":"default"}' > app/src/main/assets/config.json
        else
          cat > app/src/main/assets/config.json << EOF
        {
          "cloudflare_token": "${{ secrets.CLOUDFLARE_TOKEN }}",
          "discord_webhook": "${{ secrets.DISCORD_WEBHOOK }}",
          "github_repo": "${{ github.repository }}",
          "debug_mode": false
        }
        EOF
        fi
        
        # Movies.json bÃ¡sico
        cat > app/src/main/assets/movies.json << 'EOF'
        {
          "chunkId": "movies_001",
          "items": [{
            "id": "demo_001",
            "title": "Demo Movie",
            "description": "Demo content",
            "thumbnail": "https://via.placeholder.com/300x450",
            "url": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
            "type": "movie",
            "duration": "1:00:00",
            "year": 2024,
            "rating": 8.0
          }]
        }
        EOF
        
        # Series.json bÃ¡sico
        cat > app/src/main/assets/series.json << 'EOF'
        {
          "chunkId": "series_001",
          "items": [{
            "id": "demo_002",
            "title": "Demo Series",
            "description": "Demo series",
            "thumbnail": "https://via.placeholder.com/300x450",
            "url": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4",
            "type": "series",
            "duration": "10 episodes",
            "year": 2024,
            "rating": 7.5
          }]
        }
        EOF
        
        echo "Config files created successfully"
    
    # Make gradlew executable
    - name: ðŸ”§ Make gradlew executable
      run: |
        chmod +x gradlew
        ls -la gradlew
    
    # Build APK
    - name: ðŸ”¨ Build Release APK
      run: |
        echo "Starting build..."
        ./gradlew clean assembleRelease --no-daemon --stacktrace || ./gradlew clean assembleDebug --no-daemon --stacktrace
        echo "Build completed"
        
        # Listar APKs generados
        echo "Generated APKs:"
        find app/build/outputs/apk -name "*.apk" -type f
    
    # Get version
    - name: ðŸ·ï¸ Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="v${{ github.event.inputs.version || '1.0.0' }}"
        elif [ ! -z "${{ github.ref_name }}" ]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="v1.0.0"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version set to: $VERSION"
    
    # Prepare release files
    - name: ðŸ“¦ Prepare Release Files
      id: prepare
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "Preparing files for version: $VERSION"
        
        # Buscar el APK
        APK_PATH=""
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
        elif [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
        else
          echo "âŒ No APK found!"
          exit 1
        fi
        
        echo "Found APK at: $APK_PATH"
        
        # Copiar y renombrar
        cp "$APK_PATH" "FireTV-Streaming-${VERSION}.apk"
        
        # Verificar que existe
        if [ -f "FireTV-Streaming-${VERSION}.apk" ]; then
          echo "âœ… APK ready: FireTV-Streaming-${VERSION}.apk"
          echo "apk_name=FireTV-Streaming-${VERSION}.apk" >> $GITHUB_OUTPUT
        else
          echo "âŒ Failed to prepare APK"
          exit 1
        fi
        
        # Crear README de instalaciÃ³n
        cat > INSTALL.md << EOF
        # Installation Instructions
        
        ## Fire TV Installation
        
        1. Enable Developer Options on Fire TV
        2. Enable ADB Debugging
        3. Connect via ADB:
           \`\`\`
           adb connect YOUR_FIRETV_IP:5555
           adb install FireTV-Streaming-${VERSION}.apk
           \`\`\`
        
        ## Version: ${VERSION}
        EOF
        
        echo "Files prepared successfully"
    
    # Create GitHub Release
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: FireTV Streaming ${{ steps.version.outputs.version }}
        body: |
          ## ðŸš€ FireTV Streaming App Release
          
          ### Installation
          1. Download the APK below
          2. Enable ADB on your Fire TV
          3. Install using: `adb install ${{ steps.prepare.outputs.apk_name }}`
          
          ### What's New
          - Initial release
          - Cloudflare + Discord authentication
          - Streaming support for movies and series
          
          ---
          **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          FireTV-Streaming-*.apk
          INSTALL.md
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
