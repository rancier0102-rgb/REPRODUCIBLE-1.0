# .github/workflows/test-and-lint.yml
# =====================================
# TESTS Y ANÃLISIS DE CALIDAD
# =====================================

name: ğŸ§ª Test and Lint

on:
  pull_request:
  push:
    branches: [ main, develop ]
  
  workflow_dispatch:

jobs:
  lint-and-test:
    name: ğŸ§ª Lint and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” ESLint
        run: |
          # Instalar ESLint si no estÃ¡
          npm install --save-dev eslint
          
          # Crear config si no existe
          if [ ! -f ".eslintrc.json" ]; then
            cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true,
              "node": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 12,
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off"
            }
          }
          EOF
          fi
          
          # Run ESLint
          npx eslint src/**/*.js || true
      
      - name: ğŸ§ª Run tests
        run: |
          # Si hay tests, ejecutarlos
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test
          else
            echo "âš ï¸ No tests configured"
          fi
      
      - name: ğŸ“Š Code coverage
        run: |
          # Si hay coverage configurado
          if [ -f "package.json" ] && grep -q "\"coverage\"" package.json; then
            npm run coverage
          fi
      
      - name: ğŸ”’ Security audit
        run: |
          npm audit --production || true
