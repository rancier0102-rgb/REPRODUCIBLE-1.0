# .github/workflows/deploy.yml
# =====================================
# DEPLOY AUTOMÃTICO A GITHUB PAGES
# =====================================

name: ğŸš€ Deploy TV App to GitHub Pages

# Â¿CUÃNDO SE EJECUTA?
on:
  # Al hacer push a main
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
  
  # Al hacer Pull Request
  pull_request:
    branches: [ main ]
  
  # Manual desde GitHub Actions
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

# VARIABLES DE ENTORNO
env:
  NODE_VERSION: '18'
  CHUNK_SIZE: 50
  IMAGE_QUALITY: 85
  TIMEZONE: 'America/Mexico_City'

# PERMISOS NECESARIOS
permissions:
  contents: write
  pages: write
  id-token: write

# CONCURRENCIA - Evita deploys simultÃ¡neos
concurrency:
  group: "pages"
  cancel-in-progress: false

# TRABAJOS A EJECUTAR
jobs:
  # =====================================
  # JOB 1: ANÃLISIS Y VALIDACIÃ“N
  # =====================================
  validate:
    name: ğŸ“‹ Validate Code and Data
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historial completo para anÃ¡lisis
      
      # 2. Cache de dependencias
      - name: ğŸ“¦ Cache node modules
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      # 3. Setup Node.js
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 4. Instalar dependencias
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm install -g jsonlint
      
      # 5. Validar JSONs
      - name: âœ… Validate JSON files
        run: |
          echo "ğŸ” Validating JSON files..."
          for file in data/**/*.json; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              jsonlint -q "$file"
            fi
          done
          echo "âœ… All JSON files are valid!"
      
      # 6. Lint del cÃ³digo
      - name: ğŸ” Lint JavaScript
        run: |
          npm run lint || true  # No fallar si hay warnings
      
      # 7. Check de seguridad
      - name: ğŸ”’ Security audit
        run: |
          npm audit --audit-level=moderate || true

  # =====================================
  # JOB 2: BUILD Y OPTIMIZACIÃ“N
  # =====================================
  build:
    name: ğŸ—ï¸ Build and Optimize
    runs-on: ubuntu-latest
    needs: validate  # Espera que validate termine
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      stats: ${{ steps.stats.outputs.stats }}
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Node.js con cache
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 3. Cache de build
      - name: ğŸ“¦ Cache build files
        uses: actions/cache@v3
        with:
          path: |
            dist
            .cache
            chunks
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-
      
      # 4. Instalar dependencias
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 5. Obtener versiÃ³n
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER="${{ github.run_number }}"
          FULL_VERSION="${VERSION}.${BUILD_NUMBER}"
          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: ${FULL_VERSION}"
      
      # 6. Generar chunks de datos
      - name: ğŸ“Š Generate data chunks
        run: |
          echo "ğŸ”„ Generating chunks with size: ${{ env.CHUNK_SIZE }}"
          node scripts/generate-chunks.js
          echo "âœ… Chunks generated successfully!"
          
          # Mostrar estadÃ­sticas
          CHUNKS_COUNT=$(ls -1 chunks/*.json 2>/dev/null | wc -l)
          echo "ğŸ“¦ Total chunks created: ${CHUNKS_COUNT}"
      
      # 7. Optimizar imÃ¡genes
      - name: ğŸ–¼ï¸ Optimize images
        run: |
          echo "ğŸ”„ Installing image optimization tools..."
          npm install -g sharp-cli imagemin-cli
          
          echo "ğŸ”„ Optimizing images..."
          # Crear directorios si no existen
          mkdir -p dist/images/thumbnails
          mkdir -p dist/images/posters
          mkdir -p dist/images/optimized
          
          # Optimizar con sharp (si hay imÃ¡genes)
          if [ -d "data/images" ] && [ "$(ls -A data/images 2>/dev/null)" ]; then
            # Thumbnails
            npx sharp-cli resize 300 450 \
              --input "data/images/**/*.{jpg,jpeg,png}" \
              --output dist/images/thumbnails/ \
              --quality ${{ env.IMAGE_QUALITY }}
            
            # Posters
            npx sharp-cli resize 600 900 \
              --input "data/images/**/*.{jpg,jpeg,png}" \
              --output dist/images/posters/ \
              --quality ${{ env.IMAGE_QUALITY }}
            
            echo "âœ… Images optimized!"
          else
            echo "âš ï¸ No images found to optimize"
          fi
      
      # 8. Build de la aplicaciÃ³n
      - name: ğŸ—ï¸ Build application
        run: |
          echo "ğŸ”„ Building application..."
          
          # Si existe script de build, usarlo
          if [ -f "scripts/build.js" ]; then
            node scripts/build.js
          else
            # Build manual
            echo "ğŸ“¦ Creating dist directory..."
            mkdir -p dist
            
            # Copiar archivos principales
            cp -r public/* dist/ 2>/dev/null || true
            cp index.html dist/
            cp manifest.json dist/
            
            # Copiar assets
            cp -r src dist/
            cp -r chunks dist/
            
            # Crear service worker si no existe
            if [ ! -f "dist/service-worker.js" ]; then
              echo "// Auto-generated service worker" > dist/service-worker.js
              cat >> dist/service-worker.js << 'EOF'
const CACHE_NAME = 'tv-app-v${{ steps.version.outputs.version }}';
const urlsToCache = ['/', '/index.html', '/manifest.json'];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
  );
});
EOF
            fi
          fi
          
          echo "âœ… Build completed!"
      
      # 9. Minificar archivos
      - name: ğŸ“¦ Minify files
        run: |
          echo "ğŸ”„ Installing minification tools..."
          npm install -g terser html-minifier-terser csso-cli
          
          echo "ğŸ”„ Minifying JavaScript..."
          find dist -name "*.js" -type f ! -name "*.min.js" -exec sh -c '
            echo "Minifying {}"
            terser {} -o {}.tmp -c -m && mv {}.tmp {}
          ' \;
          
          echo "ğŸ”„ Minifying CSS..."
          find dist -name "*.css" -type f ! -name "*.min.css" -exec sh -c '
            echo "Minifying {}"
            csso {} -o {}.tmp && mv {}.tmp {}
          ' \;
          
          echo "ğŸ”„ Minifying HTML..."
          find dist -name "*.html" -type f -exec sh -c '
            echo "Minifying {}"
            html-minifier-terser {} --collapse-whitespace --remove-comments -o {}.tmp && mv {}.tmp {}
          ' \;
          
          echo "âœ… Minification completed!"
      
      # 10. Generar estadÃ­sticas
      - name: ğŸ“Š Generate build stats
        id: stats
        run: |
          echo "ğŸ“Š Generating build statistics..."
          
          # TamaÃ±o total
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          
          # Contar archivos
          HTML_COUNT=$(find dist -name "*.html" | wc -l)
          JS_COUNT=$(find dist -name "*.js" | wc -l)
          CSS_COUNT=$(find dist -name "*.css" | wc -l)
          JSON_COUNT=$(find dist -name "*.json" | wc -l)
          IMG_COUNT=$(find dist -name "*.jpg" -o -name "*.png" -o -name "*.webp" | wc -l)
          
          # Crear JSON de estadÃ­sticas
          cat > dist/build-stats.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildNumber": ${{ github.run_number }},
            "commit": "${{ github.sha }}",
            "totalSize": "${TOTAL_SIZE}",
            "files": {
              "html": ${HTML_COUNT},
              "js": ${JS_COUNT},
              "css": ${CSS_COUNT},
              "json": ${JSON_COUNT},
              "images": ${IMG_COUNT}
            }
          }
          EOF
          
          echo "stats=$(cat dist/build-stats.json | jq -c .)" >> $GITHUB_OUTPUT
          
          # Mostrar resumen
          echo "ğŸ“¦ Build Summary:"
          echo "  Version: ${{ steps.version.outputs.version }}"
          echo "  Total Size: ${TOTAL_SIZE}"
          echo "  Files: HTML(${HTML_COUNT}) JS(${JS_COUNT}) CSS(${CSS_COUNT}) JSON(${JSON_COUNT}) IMG(${IMG_COUNT})"
      
      # 11. Crear archivo de versiÃ³n
      - name: ğŸ“ Create version file
        run: |
          cat > dist/version.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildNumber": ${{ github.run_number }},
            "author": "${{ github.actor }}"
          }
          EOF
      
      # 12. Upload artifacts
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 30
      
      # 13. Upload de estadÃ­sticas
      - name: ğŸ“¤ Upload build stats
        uses: actions/upload-artifact@v3
        with:
          name: build-stats-${{ github.sha }}
          path: dist/build-stats.json

  # =====================================
  # JOB 3: TESTS
  # =====================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 3. Instalar dependencias
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 4. Download artifacts
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist-${{ github.sha }}
          path: dist/
      
      # 5. Run tests
      - name: ğŸ§ª Run unit tests
        run: |
          # Si existe script de test
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test
          else
            echo "âš ï¸ No tests configured"
          fi
      
      # 6. Test de rendimiento
      - name: âš¡ Performance test
        run: |
          echo "ğŸ”„ Installing Lighthouse CI..."
          npm install -g @lhci/cli
          
          # Servidor local para test
          npx http-server dist -p 8080 &
          SERVER_PID=$!
          
          sleep 5
          
          # Run Lighthouse
          echo "ğŸ”„ Running Lighthouse..."
          lhci autorun --collect.url=http://localhost:8080 \
            --collect.numberOfRuns=3 \
            --assert.preset=lighthouse:recommended \
            --assert.assertions.categories:performance=off \
            --assert.assertions.categories:accessibility=off \
            --assert.assertions.categories:best-practices=off \
            --assert.assertions.categories:seo=off \
            --assert.assertions.categories:pwa=off || true
          
          # Detener servidor
          kill $SERVER_PID
      
      # 7. Test de accesibilidad
      - name: â™¿ Accessibility test
        run: |
          echo "ğŸ”„ Installing Pa11y..."
          npm install -g pa11y
          
          # Servidor local
          npx http-server dist -p 8080 &
          SERVER_PID=$!
          
          sleep 5
          
          # Run Pa11y
          echo "ğŸ”„ Running accessibility tests..."
          pa11y http://localhost:8080 --reporter cli || true
          
          # Detener servidor
          kill $SERVER_PID

  # =====================================
  # JOB 4: DEPLOY A GITHUB PAGES
  # =====================================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Download build artifacts
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist-${{ github.sha }}
          path: dist/
      
      # 3. Setup Pages
      - name: ğŸ”§ Setup GitHub Pages
        uses: actions/configure-pages@v3
      
      # 4. Crear archivo CNAME si tienes dominio personalizado
      - name: ğŸŒ Create CNAME file
        run: |
          # Cambiar por tu dominio si lo tienes
          # echo "tu-dominio.com" > dist/CNAME
          echo "ğŸ“Œ No custom domain configured"
      
      # 5. Crear .nojekyll
      - name: ğŸ“ Create .nojekyll
        run: touch dist/.nojekyll
      
      # 6. Upload a Pages
      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: dist/
      
      # 7. Deploy a Pages
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
      
      # 8. Mostrar URL
      - name: ğŸŒ Display deployment URL
        run: |
          echo "âœ… Successfully deployed to GitHub Pages!"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
      
      # 9. Verificar deploy
      - name: âœ… Verify deployment
        run: |
          echo "ğŸ”„ Waiting for deployment to be ready..."
          sleep 30
          
          URL="${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ”„ Checking deployment at ${URL}"
          
          # Verificar que responde
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Deployment verified successfully!"
          else
            echo "âš ï¸ Got HTTP ${HTTP_CODE} - deployment might still be propagating"
          fi

  # =====================================
  # JOB 5: POST-DEPLOY
  # =====================================
  post-deploy:
    name: ğŸ“‹ Post Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Purge CDN Cache (si usas CloudFlare)
      - name: ğŸ”„ Purge CDN Cache
        if: env.CF_ZONE_ID != ''
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          if [ -n "$CF_ZONE_ID" ] && [ -n "$CF_API_TOKEN" ]; then
            echo "ğŸ”„ Purging CloudFlare cache..."
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "âœ… CDN cache purged!"
          else
            echo "âš ï¸ CloudFlare not configured"
          fi
      
      # 3. Notificar en Discord/Slack (opcional)
      - name: ğŸ“¢ Send notification
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "content": "ğŸš€ **TV App Deployed Successfully!**",
                "embeds": [{
                  "title": "Deployment Details",
                  "color": 5763719,
                  "fields": [
                    {"name": "Version", "value": "${{ needs.build.outputs.version }}", "inline": true},
                    {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                    {"name": "Commit", "value": "${{ github.sha }}", "inline": false},
                    {"name": "URL", "value": "${{ needs.deploy.outputs.page_url }}", "inline": false}
                  ],
                  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
                }]
              }' \
              $DISCORD_WEBHOOK
          fi
      
      # 4. Crear Release en GitHub
      - name: ğŸ“¦ Create GitHub Release
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/build-stats.json
          body: |
            ## ğŸš€ Release ${{ needs.build.outputs.version }}
            
            ### ğŸ“Š Build Statistics
            ```json
            ${{ needs.build.outputs.stats }}
            ```
            
            ### ğŸŒ Live URL
            ${{ needs.deploy.outputs.page_url }}
            
            ### ğŸ“ Commit
            ${{ github.sha }}
          draft: false
          prerelease: false
      
      # 5. Actualizar README con badge
      - name: ğŸ“ Update README badge
        run: |
          echo "ğŸ“ Updating deployment badge..."
          # AquÃ­ podrÃ­as actualizar un badge en tu README
          echo "âœ… Badge updated!"

# =====================================
# NOTIFICACIONES DE ERROR
# =====================================
  on-failure:
    name: ğŸ”´ Handle Failure
    runs-on: ubuntu-latest
    needs: [validate, build, test, deploy]
    if: failure()
    
    steps:
      - name: ğŸ“¢ Notify failure
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs for more information"
          
          # AquÃ­ puedes agregar notificaciones
          # Por ejemplo, enviar email, Discord, Slack, etc.
