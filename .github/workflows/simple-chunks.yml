name: Generate Chunks Simple

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '**.json'
      - '!manifest.json'
      - '!package*.json'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Generate chunks
      run: |
        # Crear directorios
        mkdir -p chunks data
        
        # Mostrar archivos encontrados
        echo "üìÅ Archivos JSON encontrados:"
        find . -name "*.json" -not -path "./node_modules/*" | head -20
        
        # Script inline para generar chunks
        node << 'SCRIPT'
        const fs = require('fs');
        
        console.log('üöÄ Generando chunks...\n');
        
        // Buscar archivos
        const files = [];
        
        // Buscar en data/
        if (fs.existsSync('./data')) {
          fs.readdirSync('./data')
            .filter(f => f.endsWith('.json'))
            .forEach(f => files.push(`./data/${f}`));
        }
        
        // Buscar en ra√≠z
        fs.readdirSync('.')
          .filter(f => f.includes('peliculas') && f.endsWith('.json'))
          .forEach(f => files.push(`./${f}`));
        
        console.log('Archivos encontrados:', files.length);
        
        let allMovies = [];
        
        files.forEach(file => {
          try {
            const content = fs.readFileSync(file, 'utf8');
            const data = JSON.parse(content);
            
            // Extraer pel√≠culas del formato que sea
            let movies = [];
            if (Array.isArray(data)) {
              movies = data;
            } else if (data.peliculas) {
              movies = data.peliculas;
            } else if (data.movies) {
              movies = data.movies;
            } else if (data.titulo || data.title) {
              movies = [data];
            }
            
            allMovies.push(...movies);
            console.log(`‚úì ${file}: ${movies.length} pel√≠culas`);
          } catch(e) {
            console.log(`‚úó Error en ${file}:`, e.message);
          }
        });
        
        // Si no hay pel√≠culas, crear ejemplos
        if (allMovies.length === 0) {
          console.log('\n‚ö†Ô∏è No se encontraron pel√≠culas, creando ejemplos...');
          allMovies = [
            {
              titulo: "Pel√≠cula de Ejemplo 1",
              enlace: "https://example.com/movie1",
              poster: "https://via.placeholder.com/300x450/e50914/ffffff?text=Ejemplo+1",
              year: 2024,
              genero: "Acci√≥n"
            },
            {
              titulo: "Pel√≠cula de Ejemplo 2",
              enlace: "https://example.com/movie2", 
              poster: "https://via.placeholder.com/300x450/00a8ff/ffffff?text=Ejemplo+2",
              year: 2023,
              genero: "Comedia"
            }
          ];
        }
        
        console.log(`\nTotal: ${allMovies.length} pel√≠culas`);
        
        // Comprimir pel√≠culas
        const compressed = allMovies.map(m => ({
          t: m.titulo || m.title || 'Sin t√≠tulo',
          l: m.enlace || m.link || m.url || '#',
          y: m.year || m.ano || m.a√±o || 2024,
          p: m.poster || m.image || '',
          g: m.genero || m.genre || m.categoria || '',
          q: m.calidad || m.quality || ''
        }));
        
        // Crear chunk con el formato correcto
        const chunk = {
          id: 'all',
          name: 'Todas las pel√≠culas',
          count: compressed.length,
          movies: compressed
        };
        
        // Guardar chunk
        fs.writeFileSync('chunks/all.json', JSON.stringify(chunk));
        console.log('\n‚úì Chunk creado: chunks/all.json');
        
        // Crear manifest con el formato correcto
        const manifest = {
          version: '2.0.0',
          generated: new Date().toISOString(),
          statistics: {
            totalMovies: compressed.length
          },
          chunks: [{
            id: 'all',
            file: 'chunks/all.json',
            movies: compressed.length,
            priority: 1
          }]
        };
        
        fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
        console.log('‚úì Manifest creado: manifest.json');
        
        console.log('\n‚úÖ Generaci√≥n completada!');
        console.log(`üìä Total: ${compressed.length} pel√≠culas`);
        SCRIPT
    
    - name: Verify files
      run: |
        echo ""
        echo "üìÅ Archivos generados:"
        ls -la chunks/ || echo "No chunks"
        echo ""
        echo "üìã Contenido del manifest:"
        cat manifest.json || echo "No manifest"
    
    - name: Commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git diff --staged --quiet || git commit -m "üé¨ Update chunks [skip ci]"
        git push || echo "No changes to push"
