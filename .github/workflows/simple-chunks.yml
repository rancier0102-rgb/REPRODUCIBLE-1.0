name: Generate Chunks Simple

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Generate chunks
      run: |
        # Crear directorios
        mkdir -p chunks data
        
        # Script inline simple
        node << 'SCRIPT'
        const fs = require('fs');
        
        console.log('Generando chunks...');
        
        // Buscar archivos
        const files = fs.readdirSync('.')
          .filter(f => f.includes('peliculas') && f.endsWith('.json'));
        
        let all = [];
        files.forEach(f => {
          try {
            const d = JSON.parse(fs.readFileSync(f, 'utf8'));
            all.push(...(Array.isArray(d) ? d : [d]));
            console.log(f, 'OK');
          } catch(e) {}
        });
        
        // Crear chunk
        const chunk = {movies: all, count: all.length};
        fs.writeFileSync('chunks/all.json', JSON.stringify(chunk));
        
        // Crear manifest
        const manifest = {
          chunks: [{
            id: 'all',
            file: 'chunks/all.json',
            movies: all.length
          }]
        };
        fs.writeFileSync('manifest.json', JSON.stringify(manifest));
        
        console.log('Done:', all.length, 'movies');
        SCRIPT
    
    - name: Commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git diff --staged --quiet || git commit -m "Update chunks"
        git push || true
