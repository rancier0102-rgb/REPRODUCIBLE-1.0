name: ðŸš€ Generate Movie Chunks

on:
  # Ejecutar cuando se modifican archivos JSON
  push:
    paths:
      - 'data/*.json'
      - 'peliculas_*.json'
      - 'generate-chunks.js'
  
  # Ejecutar cada domingo a medianoche
  schedule:
    - cron: '0 0 * * 0'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Forzar regeneraciÃ³n completa'
        required: false
        default: 'false'

jobs:
  generate-chunks:
    name: ðŸ“¦ Generate and Optimize Chunks
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        # NO usar cache ya que no tenemos package-lock.json
    
    - name: ðŸ“Š Check for changes
      id: check
      run: |
        echo "Verificando cambios en archivos JSON..."
        git diff --name-only HEAD^ HEAD | grep -E '\.(json|js)$' || echo "No hay cambios"
    
    - name: ðŸš€ Run chunk generator
      run: |
        echo "Ejecutando generador de chunks..."
        node generate-chunks.js
    
    - name: ðŸ“ˆ Show statistics
      run: |
        if [ -f manifest.json ]; then
          echo "ðŸ“Š EstadÃ­sticas del manifest:"
          node -e "
            const manifest = require('./manifest.json');
            console.log('Total pelÃ­culas:', manifest.statistics.totalMovies);
            console.log('Total chunks:', manifest.chunks.length);
            console.log('TamaÃ±o total:', manifest.statistics.totalSizeMB, 'MB');
          "
        fi
    
    - name: ðŸ’¾ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Agregar archivos generados
        git add chunks/ manifest.json
        
        # Verificar si hay cambios
        if git diff --staged --quiet; then
          echo "No hay cambios para commitear"
        else
          # Crear commit
          MOVIES_COUNT=$(node -e "const m=require('./manifest.json'); console.log(m.statistics.totalMovies)" 2>/dev/null || echo "0")
          git commit -m "ðŸŽ¬ Auto-generated chunks: $MOVIES_COUNT movies [skip ci]" \
                     -m "Generated on $(date '+%Y-%m-%d %H:%M:%S')" \
                     -m "Chunks: $(ls -1 chunks/*.json 2>/dev/null | wc -l || echo 0) files"
          
          # Push changes
          git push
          echo "âœ… Chunks actualizados y subidos exitosamente"
        fi
