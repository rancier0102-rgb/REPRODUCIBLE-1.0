
# .github/workflows/validate-data.yml
# =====================================
# VALIDA TODOS LOS JSON ANTES DE DEPLOY
# =====================================

name: âœ… Validate Data Files

on:
  pull_request:
    paths:
      - 'data/**/*.json'
  
  push:
    paths:
      - 'data/**/*.json'
  
  workflow_dispatch:

jobs:
  validate:
    name: âœ… Validate JSON Files
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install validators
        run: |
          npm install -g jsonlint ajv-cli
      
      - name: âœ… Validate JSON syntax
        run: |
          echo "ğŸ” Validating JSON syntax..."
          
          # Encontrar todos los JSON
          find data -name "*.json" -type f | while read file; do
            echo "Checking: $file"
            jsonlint -q "$file" || exit 1
          done
          
          echo "âœ… All JSON files have valid syntax!"
      
      - name: ğŸ“‹ Validate data structure
        run: |
          # Crear esquema de validaciÃ³n
          cat > movie-schema.json << 'EOF'
          {
            "$schema": "http://json-schema.org/draft-07/schema#",
            "type": "array",
            "items": {
              "type": "object",
              "required": ["id", "title"],
              "properties": {
                "id": { "type": "string" },
                "title": { "type": "string" },
                "year": { "type": "number" },
                "thumbnail": { "type": "string" },
                "streamUrl": { "type": "string" },
                "rating": { "type": "number", "minimum": 0, "maximum": 10 }
              }
            }
          }
          EOF
          
          # Validar contra esquema
          if [ -f "data/peliculas.json" ]; then
            echo "Validating movies data..."
            ajv validate -s movie-schema.json -d data/peliculas.json || exit 1
          fi
          
          echo "âœ… Data structure is valid!"
      
      - name: ğŸ” Check for duplicates
        run: |
          node -e "
          const fs = require('fs');
          
          // Leer archivo de pelÃ­culas
          if (fs.existsSync('data/peliculas.json')) {
            const movies = JSON.parse(fs.readFileSync('data/peliculas.json'));
            
            // Buscar IDs duplicados
            const ids = movies.map(m => m.id);
            const duplicates = ids.filter((id, index) => ids.indexOf(id) !== index);
            
            if (duplicates.length > 0) {
              console.error('âŒ Found duplicate IDs:', duplicates);
              process.exit(1);
            }
            
            console.log('âœ… No duplicate IDs found!');
            console.log('ğŸ“Š Total movies:', movies.length);
          }
          "
      
      - name: ğŸ“Š Generate report
        if: always()
        run: |
          echo "ğŸ“Š Data Validation Report"
          echo "========================="
          echo "Total JSON files: $(find data -name "*.json" | wc -l)"
          
          # TamaÃ±o de archivos
          echo ""
          echo "ğŸ“¦ File sizes:"
          find data -name "*.json" -exec ls -lh {} \; | awk '{print $9 ": " $5}'
          
          # Contar items
          if [ -f "data/peliculas.json" ]; then
            MOVIE_COUNT=$(jq '. | length' data/peliculas.json)
            echo ""
            echo "ğŸ¬ Total movies: ${MOVIE_COUNT}"
          fi
